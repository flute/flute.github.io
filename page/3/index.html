<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ludis"><meta name="msapplication-TileImage" content="/img/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ludis"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="https://ldsun.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://ldsun.com/img/og_image.png"><meta property="article:author" content="Ludis"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ldsun.com"},"headline":"Hexo","image":["https://ldsun.com/img/og_image.png"],"author":{"@type":"Person","name":"Ludis"},"publisher":{"@type":"Organization","name":"Hexo","logo":{"@type":"ImageObject","url":"https://ldsun.com/img/facvion.png"}},"description":""}</script><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.3/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/facvion.png" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="GitHub" href="https://github.com/flute"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-08-22T07:19:22.000Z" title="8/22/2018, 3:19:22 PM">2018-08-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-08-22T07:19:22.000Z" title="8/22/2018, 3:19:22 PM">2018-08-22</time></span><span class="level-item">5 minutes read (About 698 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/22/https%E9%80%9A%E9%85%8D%E7%AC%A6%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE/">https通配符证书配置</a></h1><div class="content"><p><strong>通配符证书</strong></p>
<p>即一个证书能给<code>ldsun.com</code>、<code>www.ldsun.com</code>、 <code>btc.www.ldsun.com</code>等所有的<code>*.ldsun.com</code>域名使用的证书，四不四很爽。</p>
<p><strong>免费证书</strong></p>
<p>使用 <code>let&#39;s encrypted</code> 免费开源https证书，目前已经支持通配符证书申请。</p>
<p><strong>使用脚本</strong></p>
<p>使用国人开发的脚本<code>acme.sh</code>简化配置流程。</p>
<p><strong>DNS解析商</strong></p>
<p>鉴于国内DNS服务商的尿性，选择<code>digitalocean</code>作为DNS解析商，抛弃<code>dnspod</code>，<code>dnspod</code>在设置证书过程中出现各种问题。</p>
<p><code>digitalocean</code>需要PayPal支付验证。验证后添加域名，添加解析记录。</p>
<p><strong>配置步骤</strong></p>
<p>1、安装<a target="_blank" rel="noopener" href="https://github.com/Neilpang/acme.sh/wiki/%E8%AF%B4%E6%98%8E">acme脚本</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>2、申请设置 <a target="_blank" rel="noopener" href="https://github.com/Neilpang/acme.sh/tree/master/dnsapi#20-use-digitalocean-api-native">Digitalocean API</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export DO_API_KEY=&quot;753112c4ca779ac39a19f635213b573b49ce92ae126553ebd61ac3a300934834cc&quot;</span><br></pre></td></tr></table></figure>

<p>3、申请通配符证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --issue -d ldsun.com -d &#x27;*.ldsun.com&#x27; --dns</span><br></pre></td></tr></table></figure>

<p>4、安装证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d ldsun.com \</span><br><span class="line">--key-file       /etc/nginx/ssl/ldsun.com.key  \</span><br><span class="line">--fullchain-file /etc/nginx/ssl/ldsun.com.crt \</span><br><span class="line">--reloadcmd     &quot;service nginx force-reload&quot;</span><br></pre></td></tr></table></figure>

<p>5、配置Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2 default_server;</span><br><span class="line">    listen [::]:443 ssl http2 default_server;</span><br><span class="line"></span><br><span class="line">    server_name ldsun.com www.ldsun.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header   X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header   Host      $http_host;</span><br><span class="line">        proxy_pass         http://127.0.0.1:2368;</span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ^~ /wp-content/ &#123;</span><br><span class="line">        if (!-e $request_filename) &#123;</span><br><span class="line">          rewrite ^/wp-content/uploads/(.*)$ https://obmv8nk23.qnssl.com/$1 last;</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 我们采用强大的迪菲-赫尔曼密钥交换，生成命令 openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048</span><br><span class="line">    ssl_dhparam /etc/nginx/ssl/dhparam.pem;</span><br><span class="line"></span><br><span class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">    ssl_ciphers &#x27;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&#x27;;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    ssl_session_cache shared:SSL:50m;</span><br><span class="line">    ssl_session_timeout 1d;</span><br><span class="line"></span><br><span class="line">    # 此处是证书文件</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/ldsun.com.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/ldsun.com.key;</span><br><span class="line"></span><br><span class="line">    # 开启 HSTS Preload 支持</span><br><span class="line">    add_header Strict-Transport-Security &quot;max-age=63072000; includeSubDomains; preload&quot;;</span><br><span class="line">    add_header X-Frame-Options SAMEORIGIN;</span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    add_header X-XSS-Protection &quot;1; mode=block&quot;;</span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/ldsun.com.access.log;</span><br><span class="line">    error_log /var/log/nginx/ldsun.com.error.log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    if ($host = www.ldsun.com) &#123;</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">    &#125; # managed by Certbot</span><br><span class="line">    if ($host = ldsun.com) &#123;</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name ldsun.com www.ldsun.com;</span><br><span class="line">    return 404;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>6、续期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --renew -d ldsun.com -d &#x27;*.ldsun.com&#x27; --force</span><br><span class="line"># 默认是自动更新，添加 --force 强制手动更新</span><br></pre></td></tr></table></figure>

<p><strong>参考</strong>：</p>
<p><a target="_blank" rel="noopener" href="https://sb.sb/blog/linux-acme-sh-lets-encrypt-ssl/">https://sb.sb/blog/linux-acme-sh-lets-encrypt-ssl/</a><br><a target="_blank" rel="noopener" href="https://sb.sb/blog/linux-lets-encrypt-wildcard-ssl/">https://sb.sb/blog/linux-lets-encrypt-wildcard-ssl/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-08-19T05:16:16.000Z" title="8/19/2018, 1:16:16 PM">2018-08-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-12-10T09:12:33.000Z" title="12/10/2018, 5:12:33 PM">2018-12-10</time></span><span class="level-item">10 minutes read (About 1529 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/19/%E4%BB%8E%E4%B8%80%E9%81%93%E8%8F%9C%E5%BC%80%E5%A7%8B%E9%87%8D%E6%93%8D%E6%97%A7%E4%B8%9A%E2%80%94%E2%80%94%E5%9C%9F%E8%B1%86%E9%B8%A1%E5%9D%97/">从一道菜开始重操旧业——土豆鸡块</a></h1><div class="content"><p>闲下来一看，已经四个月没写博客了。</p>
<p>入币圈这么久，这半年多却是最让人“忙”的。忙的记不起更博，虽然中途学了很多新技术，做了几个好菜想要记录，留了一年的辫子也剪成寸头。</p>
<p>正是去年年末，比特币一举达到2w多美元。从那时起，我的微信群、QQ群、小密圈等等爆发式的多了起来，每天微信和qq显示的未读消息都是999+，实际上如果软件支持的话。这个数字可能是9999+。</p>
<p>币圈的信息淹没了我。第一次感到精力完全不够用，每天都有数十个币种、ico在涌来。被信息淹没的后果，不是错过了很多信息，而是开始什么都不看了。是的，每个群，每个公众号都慢慢开始被封印。从一开始的生怕错过一条信息，到后面的无动于衷，中间的转换也是一种经历。</p>
<p>从一个吃瓜码农，到每天账户余额两位数波动。短短的一年，我竟然体验了很多的大起大落。虽然结局比较忧桑，但我却有一丝满足，因为有了这些体验，整个人的世界观价值观有了一次升级。这或许是每个参与到这种“世纪泡沫”中的人都有的体会，一切都是一个轮回，一个泡沫的萌生，高潮，退潮，再次觉醒…能参与到这种泡沫中的人都是“幸福的”，毕竟这种机会少说也是几十年一遇，而一辈子也就几十年。</p>
<p>经历了这么多之后，币圈已经变成常态。生活回归正常。</p>
<p>那么今天的主角登场：土豆鸡块的做法</p>
<p>土豆鸡块算是很实用的家常硬菜，基本是个人都喜欢吃，做法也不算复杂，直接开始把。写完去看IG vs VG九保一思聪战术了。</p>
<h3 id="材料"><a href="#材料" class="headerlink" title="材料"></a>材料</h3><ul>
<li>土豆</li>
<li>鸡块/鸡腿</li>
<li>辣椒、洋葱、红萝卜、木耳…（自选）</li>
<li>葱、姜、蒜、干辣椒（花椒大料选用）</li>
<li>豆瓣酱/火锅底料（选用）</li>
<li>生抽、老抽、料酒（自选）、白糖（自选）</li>
</ul>
<p>土豆鸡块，当然是土豆和鸡块必不可少，然后葱姜蒜也不可少，生抽老抽必备。其余加的配菜如辣椒、洋葱、红萝卜，以及调味的豆瓣酱、火锅底料都个自由选用。</p>
<h3 id="开搞"><a href="#开搞" class="headerlink" title="开搞"></a>开搞</h3><p>1、准备食材：<br>食材准备，土豆切块洗净（不洗的话淀粉容易粘锅），鸡肉用开水烫洗，洗净血水。可以用料酒，生抽加调料腌制一会，更加入味。其余食材切好备用；</p>
<p>2、炒鸡肉：<br>开火热锅，倒油。油量根据食材多少自行决定。油七分热时倒入葱、姜、蒜、干辣椒、（火锅底料），炒香后倒入鸡块翻炒，炒至肉变色，倒入老抽给肉上色。期间可加入胡椒粉、豆瓣酱等自选；</p>
<p>3、炒土豆：<br>倒入土豆（胡萝卜等自选）继续翻炒，翻炒2分钟左右；</p>
<p>4、倒水收汁：<br>倒入生抽/适量白糖（后续收汁用，根据个人口味选择咸、甜），倒入白开水没过鸡肉和土豆；</p>
<p>5、加菜提味<br>大火闷煮5分钟左右，这时候土豆和鸡肉已经熟透入味，汤汁也基本见底。这时候加入辣椒洋葱，翻炒一分钟左右，加入鸡精/味精提味。喜欢酸味的可以加入少许醋；</p>
<p>6、出锅。</p>
<p>土豆鸡块的做法也有多种，比如先把土豆炒至金黄捞出等…各个口味不一，感兴趣的自行尝试。以上做法是从母亲学来的祖传做法。</p>
<h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>没图说的口都干了。</p>
<p><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_2947%2820171019-001740%29.jpg?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_0750.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_3350.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_0746.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_0752.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_3343.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_3349.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_2886.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_4820.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"><br><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_4828.JPG?imageMogr2/thumbnail/!50p/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="cmd-markdown-logo"></p>
<p>之前做的几次的汇总图，不太全，比较乱…凑合看吧</p>
<p><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/IMG_4034.JPG" alt="cmd-markdown-logo"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-04-03T12:25:18.000Z" title="4/3/2018, 8:25:18 PM">2018-04-03</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-04-03T12:29:18.000Z" title="4/3/2018, 8:29:18 PM">2018-04-03</time></span><span class="level-item">12 minutes read (About 1740 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/03/Hyperledger-Fabric-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Hyperledger Fabric 环境搭建</a></h1><div class="content"><p>所有操作在centos7下完成，其他系统（ubuntu/macos..）类似，修改相应指令即可。</p>
<h2 id="1-安装Golang"><a href="#1-安装Golang" class="headerlink" title="1. 安装Golang"></a>1. 安装Golang</h2><p>在 <a target="_blank" rel="noopener" href="https://golang.org/dl/">golang官网</a> 获取最新版本 <code>https://dl.google.com/go/go1.10.1.linux-amd64.tar.gz</code></p>
<p>下载最新版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.google.com/go/go1.10.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -C /usr/<span class="built_in">local</span> -xzf go1.10.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>设置环境变量<code>vi ~/.bash_profile</code>，增加以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/go/bin </span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go </span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/go </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/go/bin</span><br></pre></td></tr></table></figure>

<p>重新载入环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>至此 golang 安装成功，输入<code>go version</code>查看版本</p>
<h2 id="2-安装Docker"><a href="#2-安装Docker" class="headerlink" title="2. 安装Docker"></a>2. 安装Docker</h2><p>下载并安装，使用阿里的源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -</span><br></pre></td></tr></table></figure>

<p>替换docker hub源的阿里源，加快镜像下载速度：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://obou6wyb.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>修改完后，重启docker，查看docker版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>

<h2 id="3-安装docker-compose"><a href="#3-安装docker-compose" class="headerlink" title="3. 安装docker-compose"></a>3. 安装docker-compose</h2><p>1、安装<code>pip</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo get install python-pip</span><br></pre></td></tr></table></figure>
<p>2、 下载<code>docker-compose</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` &gt; ~/docker-compose</span><br></pre></td></tr></table></figure>
<p>3、 将<code>docker-compose</code>移动至<code>/usr/local/bin</code>文件夹当中，使其作为可执行命令文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ./docker-compose /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>4、修改<code>docker-compose</code>权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>5、查看版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>

<h2 id="4-下载Fabric源码"><a href="#4-下载Fabric源码" class="headerlink" title="4. 下载Fabric源码"></a>4. 下载Fabric源码</h2><p>切换至go的<code>GOROOT</code>路径下，即第一步安装go的时候配置的路径，也可输入<code>go env</code>查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_162_219_centos ~]<span class="comment"># go env</span></span><br><span class="line">GOARCH=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">GOBIN=<span class="string">&quot;&quot;</span></span><br><span class="line">GOCACHE=<span class="string">&quot;/root/.cache/go-build&quot;</span></span><br><span class="line">GOEXE=<span class="string">&quot;&quot;</span></span><br><span class="line">GOHOSTARCH=<span class="string">&quot;amd64&quot;</span></span><br><span class="line">GOHOSTOS=<span class="string">&quot;linux&quot;</span></span><br><span class="line">GOOS=<span class="string">&quot;linux&quot;</span></span><br><span class="line">GOPATH=<span class="string">&quot;/root/go&quot;</span></span><br><span class="line">GORACE=<span class="string">&quot;&quot;</span></span><br><span class="line">GOROOT=<span class="string">&quot;/usr/local/go&quot;</span></span><br><span class="line">GOTMPDIR=<span class="string">&quot;&quot;</span></span><br><span class="line">GOTOOLDIR=<span class="string">&quot;/usr/local/go/pkg/tool/linux_amd64&quot;</span></span><br><span class="line">GCCGO=<span class="string">&quot;gccgo&quot;</span></span><br><span class="line">CC=<span class="string">&quot;gcc&quot;</span></span><br><span class="line">CXX=<span class="string">&quot;g++&quot;</span></span><br><span class="line">CGO_ENABLED=<span class="string">&quot;1&quot;</span></span><br><span class="line">CGO_CFLAGS=<span class="string">&quot;-g -O2&quot;</span></span><br><span class="line">CGO_CPPFLAGS=<span class="string">&quot;&quot;</span></span><br><span class="line">CGO_CXXFLAGS=<span class="string">&quot;-g -O2&quot;</span></span><br><span class="line">CGO_FFLAGS=<span class="string">&quot;-g -O2&quot;</span></span><br><span class="line">CGO_LDFLAGS=<span class="string">&quot;-g -O2&quot;</span></span><br><span class="line">PKG_CONFIG=<span class="string">&quot;pkg-config&quot;</span></span><br><span class="line">GOGCCFLAGS=<span class="string">&quot;-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build440227295=/tmp/go-build -gno-record-gcc-switches&quot;</span></span><br></pre></td></tr></table></figure>

<p>切换至<code>/usr/local/go</code>目录后，进入<code>src</code>代码目录。如果不存在<code>github.com</code>文件夹，则新建一个。在<code>github.com</code>下新建<code>hyperledger</code>文件夹并进入，此时所在路径为： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/go/src/github.com/hyperledger</span><br></pre></td></tr></table></figure>

<p>在当前目录下，从github拉取fabric源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/hyperledger/fabric.git</span><br></pre></td></tr></table></figure>

<p>本次使用<code>1.0.0</code>版本（与后面安装的docker fabric镜像版本保持一致！）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> fabric</span><br><span class="line">git checkout v1.0.0</span><br></pre></td></tr></table></figure>

<p>到此为止，fabric源码下载成功。</p>
<h2 id="5-下载Docker-Fabric镜像"><a href="#5-下载Docker-Fabric镜像" class="headerlink" title="5. 下载Docker Fabric镜像"></a>5. 下载Docker Fabric镜像</h2><p>切换到下载的fabric源码目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/go/src/github.com/hyperledger/fabric/examples/e2e_cli</span><br></pre></td></tr></table></figure>

<p>利用源码中的脚本下载<code>1.0.0</code>版本的fabric docker镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ./download-dockerimages.sh -c x86_64-1.0.0 -f x86_64-1.0.0</span><br></pre></td></tr></table></figure>

<p>下载完后可以执行<code>docker images</code>查看镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_162_219_centos e2e_cli]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                               TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">dev-peer1.org2.example.com-mycc-1.0      latest              93a9797573ad        2 hours ago         173 MB</span><br><span class="line">dev-peer0.org1.example.com-mycc-1.0      latest              bef7e3211370        2 hours ago         173 MB</span><br><span class="line">dev-peer0.org2.example.com-mycc-1.0      latest              2884f1a84570        2 hours ago         173 MB</span><br><span class="line">docker.io/hello-world                    latest              f2a91732366c        4 months ago        1.85 kB</span><br><span class="line">docker.io/hyperledger/fabric-tools       x86_64-1.0.0        0403fd1c72c7        8 months ago        1.32 GB</span><br><span class="line">hyperledger/fabric-tools                 latest              0403fd1c72c7        8 months ago        1.32 GB</span><br><span class="line">docker.io/hyperledger/fabric-couchdb     x86_64-1.0.0        2fbdbf3ab945        8 months ago        1.48 GB</span><br><span class="line">hyperledger/fabric-couchdb               latest              2fbdbf3ab945        8 months ago        1.48 GB</span><br><span class="line">docker.io/hyperledger/fabric-kafka       x86_64-1.0.0        dbd3f94de4b5        8 months ago        1.3 GB</span><br><span class="line">hyperledger/fabric-kafka                 latest              dbd3f94de4b5        8 months ago        1.3 GB</span><br><span class="line">docker.io/hyperledger/fabric-zookeeper   x86_64-1.0.0        e545dbf1c6af        8 months ago        1.31 GB</span><br><span class="line">hyperledger/fabric-zookeeper             latest              e545dbf1c6af        8 months ago        1.31 GB</span><br><span class="line">docker.io/hyperledger/fabric-orderer     x86_64-1.0.0        e317ca5638ba        8 months ago        179 MB</span><br><span class="line">hyperledger/fabric-orderer               latest              e317ca5638ba        8 months ago        179 MB</span><br><span class="line">hyperledger/fabric-peer                  latest              6830dcd7b9b5        8 months ago        182 MB</span><br><span class="line">docker.io/hyperledger/fabric-peer        x86_64-1.0.0        6830dcd7b9b5        8 months ago        182 MB</span><br><span class="line">docker.io/hyperledger/fabric-javaenv     x86_64-1.0.0        8948126f0935        8 months ago        1.42 GB</span><br><span class="line">hyperledger/fabric-javaenv               latest              8948126f0935        8 months ago        1.42 GB</span><br><span class="line">docker.io/hyperledger/fabric-ccenv       x86_64-1.0.0        7182c260a5ca        8 months ago        1.29 GB</span><br><span class="line">hyperledger/fabric-ccenv                 latest              7182c260a5ca        8 months ago        1.29 GB</span><br><span class="line">docker.io/hyperledger/fabric-ca          x86_64-1.0.0        a15c59ecda5b        8 months ago        238 MB</span><br><span class="line">hyperledger/fabric-ca                    latest              a15c59ecda5b        8 months ago        238 MB</span><br><span class="line">docker.io/hyperledger/fabric-baseos      x86_64-0.3.1        4b0cab202084        10 months ago       157 MB</span><br></pre></td></tr></table></figure>

<h2 id="6-启动Fabric网络"><a href="#6-启动Fabric网络" class="headerlink" title="6. 启动Fabric网络"></a>6. 启动Fabric网络</h2><p>启动Fabric网络实际上是启动下载的Fabric Docker镜像，并执行一系列命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/go/src/github.com/hyperledger/fabric/examples/e2e_cli</span><br><span class="line"></span><br><span class="line">./network_setup.sh up</span><br></pre></td></tr></table></figure>

<p>最终出现以下提示时启动成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">===================== Query on PEER3 on channel <span class="string">&#x27;mychannel&#x27;</span> is successful =====================</span><br><span class="line"></span><br><span class="line">===================== All GOOD, End-2-End execution completed =====================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _____   _   _   ____            _____   ____    _____</span><br><span class="line">| ____| | \ | | |  _ \          | ____| |___ \  | ____|</span><br><span class="line">|  _|   |  \| | | | | |  _____  |  _|     __) | |  _|</span><br><span class="line">| |___  | |\  | | |_| | |_____| | |___   / __/  | |___</span><br><span class="line">|_____| |_| \_| |____/          |_____| |_____| |_____|</span><br></pre></td></tr></table></figure>

<p>启动成功后，可以<code>control+c</code>退出，fabric并不会中止，而是在后台运行在docker中。</p>
<h2 id="7-使用合约测试Fabric网络"><a href="#7-使用合约测试Fabric网络" class="headerlink" title="7. 使用合约测试Fabric网络"></a>7. 使用合约测试Fabric网络</h2><p>前面下载的fabric源码中包含了一个合约示例，当启动Fabric网络之后，启动了一个名为<code>mychannel</code>的channel及一个名为<code>mycc</code>的链码。</p>
<p>首先连接到Fabric网络所在的docker容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it cli bash</span><br></pre></td></tr></table></figure>

<p>该<code>mycc</code>的合约定义了两个账户a和b，分别查看他们的账户余额:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C mychannel -n mycc -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n mycc -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>Query Result</code>为账户余额</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@6762dba419ff:/opt/gopath/src/github.com/hyperledger/fabric/peer<span class="comment"># peer chaincode query -C mychannel -n mycc -c &#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#x27;</span></span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-04-03 12:03:14.367 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</span><br><span class="line">2018-04-03 12:03:14.367 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp/identity] Sign -&gt; DEBU 005 Sign: plaintext: 0A95070A6708031A0C0882DB8DD60510...6D7963631A0A0A0571756572790A0161</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: digest: 51A66C3205697E626DDDD25E6995FBCC04BDBD6D602E68959D2995EC13DEC8E1</span><br><span class="line">Query Result: 90</span><br><span class="line">2018-04-03 12:03:14.373 UTC [main] main -&gt; INFO 007 Exiting.....</span><br><span class="line">2018-04-03 12:03:14.373 UTC [main] main -&gt; INFO 007 Exiting.....</span><br><span class="line">root@6762dba419ff:/opt/gopath/src/github.com/hyperledger/fabric/peer<span class="comment"># peer chaincode query -C mychannel -n mycc -c &#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]&#125;&#x27;</span></span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-04-03 12:08:36.201 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</span><br><span class="line">2018-04-03 12:08:36.201 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp/identity] Sign -&gt; DEBU 005 Sign: plaintext: 0A94070A6608031A0B08C4DD8DD60510...6D7963631A0A0A0571756572790A0162</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: digest: 0E7915778933F605D5B7D04D52FFF7608F390E0AF2A7B37C6C3FA6027747DF56</span><br><span class="line">Query Result: 210</span><br><span class="line">2018-04-03 12:08:36.207 UTC [main] main -&gt; INFO 007 Exiting.....</span><br></pre></td></tr></table></figure>

<p>使用合约的<code>invoke</code>方法，从a账户转账20给b账户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o orderer.example.com:7050 --tls <span class="literal">true</span> --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C mychannel -n mycc -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;20&quot;]&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>转账成功后再次查询a和b的余额，此时余额已经发生变化。转账成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@6762dba419ff:/opt/gopath/src/github.com/hyperledger/fabric/peer<span class="comment"># peer chaincode query -C mychannel -n mycc -c &#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]&#125;&#x27;</span></span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-04-03 12:03:14.367 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</span><br><span class="line">2018-04-03 12:03:14.367 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp/identity] Sign -&gt; DEBU 005 Sign: plaintext: 0A95070A6708031A0C0882DB8DD60510...6D7963631A0A0A0571756572790A0161</span><br><span class="line">2018-04-03 12:03:14.367 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: digest: 51A66C3205697E626DDDD25E6995FBCC04BDBD6D602E68959D2995EC13DEC8E1</span><br><span class="line">Query Result: 70</span><br><span class="line">2018-04-03 12:03:14.373 UTC [main] main -&gt; INFO 007 Exiting.....</span><br><span class="line">root@6762dba419ff:/opt/gopath/src/github.com/hyperledger/fabric/peer<span class="comment"># peer chaincode query -C mychannel -n mycc -c &#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]&#125;&#x27;</span></span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp] GetLocalMSP -&gt; DEBU 001 Returning existing <span class="built_in">local</span> MSP</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 002 Obtaining default signing identity</span><br><span class="line">2018-04-03 12:08:36.201 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 003 Using default escc</span><br><span class="line">2018-04-03 12:08:36.201 UTC [chaincodeCmd] checkChaincodeCmdParams -&gt; INFO 004 Using default vscc</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp/identity] Sign -&gt; DEBU 005 Sign: plaintext: 0A94070A6608031A0B08C4DD8DD60510...6D7963631A0A0A0571756572790A0162</span><br><span class="line">2018-04-03 12:08:36.201 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: digest: 0E7915778933F605D5B7D04D52FFF7608F390E0AF2A7B37C6C3FA6027747DF56</span><br><span class="line">Query Result: 230</span><br><span class="line">2018-04-03 12:08:36.207 UTC [main] main -&gt; INFO 007 Exiting.....</span><br></pre></td></tr></table></figure>

<p>至此fabric环境搭建成功，测试成功。</p>
<p>退出docker容器<code>exit</code></p>
<p>停止fabric docker进程，中止fabric网络</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/go/src/github.com/hyperledger/fabric/examples/e2e_cli</span><br><span class="line"></span><br><span class="line">./network_setup.sh down</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-03-12T13:09:34.000Z" title="3/12/2018, 9:09:34 PM">2018-03-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-03-12T13:14:59.000Z" title="3/12/2018, 9:14:59 PM">2018-03-12</time></span><span class="level-item">13 minutes read (About 1897 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/12/%E6%90%AD%E5%BB%BAETH%E7%A7%81%E9%93%BE%E5%B9%B6%E5%88%9B%E5%BB%BAERC20-Token/">搭建ETH私链并创建ERC20 Token</a></h1><div class="content"><h3 id="1、下载ETH钱包"><a href="#1、下载ETH钱包" class="headerlink" title="1、下载ETH钱包"></a>1、下载ETH钱包</h3><p><a target="_blank" rel="noopener" href="https://github.com/ethereum/mist/releases">下载</a> Ethereum Wallet或Mist其一即可，二者功能相同。</p>
<h3 id="2、安装geth"><a href="#2、安装geth" class="headerlink" title="2、安装geth"></a>2、安装geth</h3><p>Mac下使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install geth</span><br></pre></td></tr></table></figure>

<p>其余平台参考<a target="_blank" rel="noopener" href="https://geth.ethereum.org/downloads/">安装方法</a></p>
<h3 id="3、编辑创世区块配置文件"><a href="#3、编辑创世区块配置文件" class="headerlink" title="3、编辑创世区块配置文件"></a>3、编辑创世区块配置文件</h3><p><code>genesis.json</code>：（<a target="_blank" rel="noopener" href="https://gist.github.com/dickolsson/e652b3d0e7bee55aa0a582d8a03900bf">参考示例</a>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook  ~  cd Desktop/ethereum</span><br><span class="line">ludis@MacBook  ~/Desktop/ethereum cat &gt; genesis.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;config&quot;: &#123;</span><br><span class="line">    &quot;chainId&quot;: 33,</span><br><span class="line">    &quot;homesteadBlock&quot;: 0,</span><br><span class="line">    &quot;eip155Block&quot;: 0,</span><br><span class="line">    &quot;eip158Block&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;nonce&quot;: &quot;0x0000000000000033&quot;,</span><br><span class="line">  &quot;timestamp&quot;: &quot;0x0&quot;,</span><br><span class="line">  &quot;parentHash&quot;: &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,</span><br><span class="line">  &quot;gasLimit&quot;: &quot;0x8000000&quot;,</span><br><span class="line">  &quot;difficulty&quot;: &quot;0x100&quot;,</span><br><span class="line">  &quot;mixhash&quot;: &quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,</span><br><span class="line">  &quot;coinbase&quot;: &quot;0x3333333333333333333333333333333333333333&quot;,</span><br><span class="line">  &quot;alloc&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">^c</span><br></pre></td></tr></table></figure>

<h3 id="4、初始化"><a href="#4、初始化" class="headerlink" title="4、初始化"></a>4、初始化</h3><p>初始化区块链，并且创建一个文件夹来存储区块数据。由于第一步下载的钱包，其默认的区块数据存储在<code>~/Library/Ethereum</code>目录，所以初始化时，将存储区块数据的文件夹指向该目录，这样钱包就和我们创建的私链绑定起来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth init genesis.json --datadir ~/Library/Ethereum</span><br></pre></td></tr></table></figure>

<p>启动私链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth --networkid 10 --rpc --rpcapi <span class="string">&quot;admin,debug,eth,miner,net,personal,shh,txpool,web3&quot;</span> rpcaddr <span class="string">&quot;0.0.0.0&quot;</span> --rpccorsdomain <span class="string">&quot;*&quot;</span> --nodiscover  --dev console</span><br></pre></td></tr></table></figure>
<p>终端另开一个窗口，连接本地私链节点，开始挖矿。<code>miner.start(1)</code>传的参数为挖矿所用的线程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">geth attach &#x27;http://127.0.0.1:8545&#x27;</span><br><span class="line">miner.start(1)</span><br></pre></td></tr></table></figure>
<p>如果提示挖矿账户错误，则需要设置挖矿账户为自己的钱包地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">miner.setEtherbase(&quot;7df9a875a174b3bc565e6424a0050ebc1b2d1d82&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="5、启动钱包"><a href="#5、启动钱包" class="headerlink" title="5、启动钱包"></a>5、启动钱包</h3><p>当私链启动后，打开钱包，这是会显示连接到私链成功。点击<code>LAUNCH APPLICATION</code>进入钱包后，创建一个账户即可。</p>
<p>如果打开钱包，显示在同步节点数据，则说明本地私链启动失败，或与钱包绑定失败。</p>
<h3 id="6、创建ERC20-token"><a href="#6、创建ERC20-token" class="headerlink" title="6、创建ERC20 token"></a>6、创建ERC20 token</h3><p>创建一个基于ERC20规范的token，合约代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.19;</span><br><span class="line"></span><br><span class="line">  // ----------------------------------------------------------------------------------------------</span><br><span class="line">  // Sample fixed supply token contract</span><br><span class="line">  // Enjoy. (c) BokkyPooBah 2017. The MIT Licence.</span><br><span class="line">  // ----------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">   // ERC Token Standard #20 Interface</span><br><span class="line">  // https://github.com/ethereum/EIPs/issues/20</span><br><span class="line"></span><br><span class="line">contract ERC20Interface &#123;</span><br><span class="line">      // 获取总的支持量</span><br><span class="line">    function totalSupply() constant returns (uint256 totalSupply);</span><br><span class="line"></span><br><span class="line">      // 获取其他地址的余额</span><br><span class="line">    function balanceOf(address _owner) constant returns (uint256 balance);</span><br><span class="line"></span><br><span class="line">      // 向其他地址发送token</span><br><span class="line">    function transfer(address _to, uint256 _value) returns (bool success);</span><br><span class="line"></span><br><span class="line">      // 从一个地址想另一个地址发送余额</span><br><span class="line">    function transferFrom(address _from, address _to, uint256 _value) returns (bool success);</span><br><span class="line"></span><br><span class="line">      //允许_spender从你的账户转出_value的余额，调用多次会覆盖可用量。某些DEX功能需要此功能</span><br><span class="line">    function approve(address _spender, uint256 _value) returns (bool success);</span><br><span class="line"></span><br><span class="line">      // 返回_spender仍然允许从_owner退出的余额数量</span><br><span class="line">    function allowance(address _owner, address _spender) constant returns (uint256 remaining);</span><br><span class="line"></span><br><span class="line">      // token转移完成后出发</span><br><span class="line">    event Transfer(address indexed _from, address indexed _to, uint256 _value);</span><br><span class="line"></span><br><span class="line">      // approve(address _spender, uint256 _value)调用后触发</span><br><span class="line">    event Approval(address indexed _owner, address indexed _spender, uint256 _value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//继承接口后的实例</span><br><span class="line"></span><br><span class="line">contract FixedSupplyToken is ERC20Interface &#123;</span><br><span class="line">    string public constant symbol = &quot;XC&quot;; //单位</span><br><span class="line">    string public constant name = &quot;X Coin&quot;; //名称</span><br><span class="line">    uint8 public constant decimals = 18; //小数点后的位数</span><br><span class="line">    uint256 _totalSupply = 100000000000000000000000000000; //发行总量</span><br><span class="line"></span><br><span class="line">    // 智能合约的所有者</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    // 每个账户的余额</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line"></span><br><span class="line">    // 帐户的所有者批准将金额转入另一个帐户。从上面的说明我们可以得知allowed[被转移的账户][转移钱的账户]</span><br><span class="line">    mapping(address =&gt; mapping (address =&gt; uint256)) allowed;</span><br><span class="line"></span><br><span class="line">    // 只能通过智能合约的所有者才能调用的方法</span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        assert(msg.sender == owner);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 构造函数</span><br><span class="line">    function FixedSupplyToken(string _symbol,string _name) public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        balances[owner] = _totalSupply;</span><br><span class="line">        //symbol = _symbol;</span><br><span class="line">        //name = _name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function totalSupply() constant public returns (uint256 totalSupply) &#123;</span><br><span class="line">        totalSupply = _totalSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 特定账户的代币余额</span><br><span class="line">    function balanceOf(address _owner) constant public returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 转移余额到其他账户</span><br><span class="line">    function transfer(address _to, uint256 _amount) public returns (bool success) &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount &amp;&amp; _amount &gt; 0 &amp;&amp; balances[_to] + _amount &gt; balances[_to]) &#123;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">            balances[_to] += _amount;</span><br><span class="line">            // balances[交易所地址] += 1;</span><br><span class="line">            Transfer(msg.sender, _to, _amount);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //从一个账户转移到另一个账户，前提是需要有允许转移的余额</span><br><span class="line">    function transferFrom(</span><br><span class="line">        address _from,</span><br><span class="line">        address _to,</span><br><span class="line">        uint256 _amount</span><br><span class="line">    ) public returns (bool success) &#123;</span><br><span class="line">        if (balances[_from] &gt;= _amount</span><br><span class="line">            &amp;&amp; allowed[_from][msg.sender] &gt;= _amount</span><br><span class="line">            &amp;&amp; _amount &gt; 0</span><br><span class="line">            &amp;&amp; balances[_to] + _amount &gt; balances[_to]) &#123;</span><br><span class="line">            balances[_from] -= _amount;</span><br><span class="line">            allowed[_from][msg.sender] -= _amount;</span><br><span class="line">            balances[_to] += _amount;</span><br><span class="line">            Transfer(_from, _to, _amount);</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //允许账户从当前用户转移余额到那个账户，多次调用会覆盖</span><br><span class="line">    function approve(address _spender, uint256 _amount) public returns (bool success) &#123;</span><br><span class="line">        allowed[msg.sender][_spender] = _amount;</span><br><span class="line">        Approval(msg.sender, _spender, _amount);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //返回被允许转移的余额数量</span><br><span class="line">    function allowance(address _owner, address _spender) constant public returns (uint256 remaining) &#123;</span><br><span class="line">        return allowed[_owner][_spender];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7、创建项目"><a href="#7、创建项目" class="headerlink" title="7、创建项目"></a>7、创建项目</h3><p><strong>1.</strong> 创建一个node项目，来实现合约的编译、部署功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook  ~  cd Desktop/contract</span><br><span class="line">ludis@MacBook  ~  /Desktop/contract npm init</span><br><span class="line">This utility will walk you through creating a package.json file.</span><br><span class="line">It only covers the most common items, and tries to guess sensible defaults.</span><br><span class="line"></span><br><span class="line">See `npm help json` for definitive documentation on these fields</span><br><span class="line">and exactly what they do.</span><br><span class="line"></span><br><span class="line">Use `npm install &lt;pkg&gt;` afterwards to install a package and</span><br><span class="line">save it as a dependency in the package.json file.</span><br><span class="line"></span><br><span class="line">Press ^C at any time to quit.</span><br><span class="line">package name: (contract)</span><br><span class="line">version: (1.0.0)</span><br><span class="line">description:</span><br><span class="line">entry point: (index.js)</span><br><span class="line">test command:</span><br><span class="line">git repository:</span><br><span class="line">keywords:</span><br><span class="line">author:</span><br><span class="line">license: (ISC)</span><br><span class="line">About to write to /Users/ludis/Desktop/contract/package.json:</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;contract&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;author&quot;: &quot;&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;ISC&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Is this ok? (yes)</span><br></pre></td></tr></table></figure>
<p>一路回车后初始化了一个node项目，接着安装所需的依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook  ~/Desktop/contract cnpm i -S ganache-cli solc web3</span><br></pre></td></tr></table></figure>
<p>创建以下目录结构:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build</span><br><span class="line">├── compile.js</span><br><span class="line">├── contracts</span><br><span class="line">├── deploy.js</span><br><span class="line">├── node_modules</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>
<p>将第六步的合约命名为<code>FixedSupplyToken.sol</code>保存在<code>contracts</code>文件夹</p>
<p><strong>2.</strong> <code>compile.js</code>为编译合约用的脚本:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">//compile.js 赋值编译智能合约</span><br><span class="line"></span><br><span class="line">//require(&#x27;库名/路径&#x27;)</span><br><span class="line">const solc = require(&#x27;solc&#x27;);</span><br><span class="line">//fs: file system</span><br><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line"></span><br><span class="line">const path = require(&#x27;path&#x27;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//1.读取智能合约</span><br><span class="line">//readFileSync 同步读取文件</span><br><span class="line"></span><br><span class="line">//__dirname =&gt;返回当前路径</span><br><span class="line">console.log(__dirname);</span><br><span class="line">//resolve路径拼接的方法</span><br><span class="line">const filepath = path.resolve(__dirname,&#x27;contracts&#x27;,&#x27;FixedSupplyToken.sol&#x27;);</span><br><span class="line">const contractFile = fs.readFileSync(filepath,&#x27;utf8&#x27;);</span><br><span class="line"></span><br><span class="line">// console.log(contractFile);</span><br><span class="line"></span><br><span class="line">//通过solc库来编译智能合约</span><br><span class="line"></span><br><span class="line">var output = solc.compile(contractFile,1);</span><br><span class="line">// console.log(output);</span><br><span class="line">//output = &#123;contracts:&#x27;&#x27;,errors:&#x27;&#x27;,sourceLiser:&#x27;&#x27;&#125;</span><br><span class="line">const contracts = output.contracts;</span><br><span class="line">// console.log(contracts);</span><br><span class="line">//for in 操作: contract = 对象 中的 属性名</span><br><span class="line">for (let contract in contracts) &#123;</span><br><span class="line">    // console.log(contract)</span><br><span class="line">        //contracts[contract]</span><br><span class="line">        //写文件 fs</span><br><span class="line">        // console.log(contract);</span><br><span class="line">    let newfilepath = path.resolve(__dirname, &#x27;build&#x27;, contract.replace(&#x27;:&#x27;,&#x27;&#x27;) + &#x27;.json&#x27;);</span><br><span class="line">    // console.log(newfilepath);</span><br><span class="line">    //fs.writeFileSync(目标路径, 写入内容)</span><br><span class="line">    //对象, tostring()方法, 返回是一个[object object] 字符串</span><br><span class="line">    //JSON.stringify =&gt; 将对象装换为字符串</span><br><span class="line">    fs.writeFileSync(newfilepath, JSON.stringify(contracts[contract]));</span><br><span class="line">&#125;</span><br><span class="line">//console.log(contracts);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>3.</strong> <code>deploy.js</code>为部署合约用的脚本:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const ganache = require(&#x27;ganache-cli&#x27;);</span><br><span class="line">const Web3    = require(&#x27;web3&#x27;);</span><br><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line">const path = require(&#x27;path&#x27;);</span><br><span class="line"></span><br><span class="line">// web3 小写是实例, Web3 是类</span><br><span class="line">// web3 的构造函数需要传入一个rpc 地址 =&gt; provider(http, websocket)</span><br><span class="line">// 内存虚拟节点</span><br><span class="line">// const web3 = new Web3(ganache.provider());</span><br><span class="line">// 直接通过 http://127.0.0.1:8545链接到自己的节点</span><br><span class="line">const web3 = new Web3(&#x27;http://127.0.0.1:8545&#x27;);</span><br><span class="line"></span><br><span class="line">// 获取编译后的合约代码</span><br><span class="line">const contractpath = path.resolve(__dirname,&#x27;build/FixedSupplyToken.json&#x27;)</span><br><span class="line">// 解析成为json对象</span><br><span class="line">const contract = JSON.parse(fs.readFileSync(contractpath,&#x27;utf8&#x27;));</span><br><span class="line"></span><br><span class="line">// 构建一个智能合约对象</span><br><span class="line"></span><br><span class="line">let myContract = new web3.eth.Contract(JSON.parse(contract.interface));</span><br><span class="line"></span><br><span class="line">web3.eth.getAccounts()</span><br><span class="line">.then(accounts =&gt; &#123;</span><br><span class="line">  // web3.personal.unlockAccount(eth.accounts[0],&quot;asdqwe123&quot;, 15000)</span><br><span class="line">    myContract.deploy(&#123;</span><br><span class="line">        data: &#x27;0x&#x27; + contract.bytecode,// bytecode</span><br><span class="line">        arguments: [&quot;MT&quot;, &#x27;My TOKEN&#x27;] // 合约构造函数参数s</span><br><span class="line">    &#125;)</span><br><span class="line">    .send(&#123;</span><br><span class="line">        from:accounts[0],</span><br><span class="line">        gas: 1500000, // gas 消耗最大值</span><br><span class="line">        gasPrice: web3.utils.toWei(&quot;0.0000002&quot;, &quot;ether&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(d =&gt; &#123; // 部署合约的返回结果是实例对象</span><br><span class="line">        d.methods.name().call().then(r =&gt; &#123;</span><br><span class="line">            console.log(r);</span><br><span class="line">        &#125;);</span><br><span class="line">        // 合约方法调用</span><br><span class="line">        // 合约实例.methods.方法名(方法参数).call()</span><br><span class="line">        d.methods.totalSupply().call().then(r =&gt; &#123;</span><br><span class="line">            console.log(r);</span><br><span class="line">        &#125;)</span><br><span class="line">        // console.log(d)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8、编译部署"><a href="#8、编译部署" class="headerlink" title="8、编译部署"></a>8、编译部署</h3><p>编译: <code>node compile.js</code>，编译成功会在<code>build</code>文件夹生成编译完的json文件</p>
<p>部署: <code>node deploy.js</code>，部署时会提示钱包账户解锁问题，只需终端执行<code>web3.personal.unlockAccount(eth.accounts[0],&quot;password&quot;, 15000)</code>，然后再部署即可。</p>
<p>部署成功后终端挖矿页面会显示区块的打包信息，当合约部署成功时会显示合约地址。然后把合约地址添加到钱包的<code>contracts-&gt;token</code>中，就会显示该合约下的token数量。可以新建多个用户转账测试。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-03-06T13:31:35.000Z" title="3/6/2018, 9:31:35 PM">2018-03-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-03-09T08:15:12.000Z" title="3/9/2018, 4:15:12 PM">2018-03-09</time></span><span class="level-item">13 minutes read (About 1909 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/06/DAPP%E7%BB%93%E5%90%88IPFS-%E2%80%94-%E5%8E%BB%E4%B8%AD%E5%BF%83%E5%8C%96%E5%9B%BE%E5%BA%8A/">DAPP结合IPFS — 去中心化图床</a></h1><div class="content"><p><strong>内容</strong>：打造一款去中心化图床，用户可上传图片至IPFS上，文件hash保存在以太坊的区块上，以此实现永存的去中心化图床。</p>
<p><strong>技术栈</strong>：依旧使用<code>truffle</code>框架快速构建项目<code>truffle unbox react</code></p>
<h3 id="1、什么是-IPFS"><a href="#1、什么是-IPFS" class="headerlink" title="1、什么是 IPFS"></a>1、什么是 IPFS</h3><p>星际文件系统IPFS（InterPlanetary File System）是一个面向全球的、点对点的分布式版本文件系统，目标是为了补充（甚至是取代）目前统治互联网的超文本传输协议（HTTP），将所有具有相同文件系统的计算设备连接在一起。原理用基于内容的地址替代基于域名的地址，也就是用户寻找的不是某个地址而是储存在某个地方的内容，不需要验证发送者的身份，而只需要验证内容的哈希，通过这样可以让网页的速度更快、更安全、更健壮、更持久。</p>
<p>直白了说，就是类似BT下载的p2p文件存储、传输系统。</p>
<h3 id="2、安装-IPFS"><a href="#2、安装-IPFS" class="headerlink" title="2、安装 IPFS"></a>2、安装 IPFS</h3><p><a target="_blank" rel="noopener" href="https://ipfs.io/">IPFS官网</a>下载对应系统的安装包（需要翻墙）<br>以Mac为例，终端执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/ludis/Downloads</span><br><span class="line"></span><br><span class="line">tar xvfz go-ipfs_v0.4.13_darwin-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> go-ipfs</span><br><span class="line"></span><br><span class="line">mv ipfs /usr/<span class="built_in">local</span>/bin/ipfs</span><br><span class="line"></span><br><span class="line">// 创建本地节点</span><br><span class="line">ipfs init</span><br><span class="line"></span><br><span class="line">// 查看节点ID</span><br><span class="line">ipfs id</span><br><span class="line"></span><br><span class="line">// 启动节点服务器（可以上传文件至外网/同步外网文件）</span><br><span class="line">ipfs daemon</span><br></pre></td></tr></table></figure>

<p>ipfs节点服务器启动之后可以浏览器访问<code>http://localhost:5001/webui</code>查看管理界面，有本地配置信息、节点连接信息、本地节点文件信息等等。</p>
<h3 id="3、IPFS-基本操作"><a href="#3、IPFS-基本操作" class="headerlink" title="3、IPFS 基本操作"></a>3、IPFS 基本操作</h3><p>1、新建文件并添加至IPFS节点</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook ~/Desktop/<span class="built_in">test</span> cat &gt; file.txt</span><br><span class="line">hello ipfs!</span><br><span class="line">^C</span><br><span class="line">ludis@MacBook ~/Desktop/<span class="built_in">test</span> cat file.txt</span><br><span class="line">hello ipfs!</span><br><span class="line">ludis@MacBook ~/Desktop/<span class="built_in">test</span> ipfs add file.txt</span><br><span class="line">added QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte file.txt</span><br></pre></td></tr></table></figure>
<p>将文件添加至ipfs节点后，会返回文件的hash，上例<code>QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</code></p>
<p>2、查看IPFS上的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook ~/Desktop/test ipfs cat QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</span><br><span class="line">hello ipfs!</span><br></pre></td></tr></table></figure>
<p>此时文件只是添加到了本地的IPFS节点，可以通过终端读取到。<br>当通过<code>ipfs daemon</code>启动本地节点服务器后，也可以通过<code>http://localhost:8080/ipfs/QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</code>访问到文件。<br>在启动节点服务器后，会将本地节点文件同步至外网，当同步完成后，就可以通过<code>https://ipfs.io/iofs/QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</code>访问到文件。至此你的文件已经永存在ipfs网络上了！<br>由于目前IPFS网络暂未加入代币机制，所以存储读取文件均免费，当然了，速度也慢很多。</p>
<p>3、下载IPFS上的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook ~/Desktop/test ipfs get QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</span><br><span class="line">Saving file(s) to QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte</span><br><span class="line"> 20 B / 20 B [========================================] 100.00% 0s</span><br></pre></td></tr></table></figure>

<p>通过get命令，会下载文件到当前目录。</p>
<p>4、新建目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook  ~/Desktop/<span class="built_in">test</span>  ipfs files mkdir /ludis</span><br><span class="line">ludis@MacBook  ~/Desktop/<span class="built_in">test</span>  ipfs files cp /ipfs/QmZ5cRqiNsg1ngmzmKrv5STMoyfLaJhhHqXyMWTkre1qte /ludis/readme.txt</span><br><span class="line">ludis@MacBook  ~/Desktop/<span class="built_in">test</span>  ipfs files ls</span><br><span class="line">ludis</span><br><span class="line">ludis@MacBook  ~/Desktop/<span class="built_in">test</span>  ipfs files ls /ludis</span><br><span class="line">readme.txt</span><br><span class="line">ludis@MacBook  ~/Desktop/<span class="built_in">test</span>  ipfs files <span class="built_in">read</span> /ludis/readme.txt</span><br><span class="line">hello ipfs!</span><br></pre></td></tr></table></figure>

<p>5、上传整个目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipfs add -r files/</span><br></pre></td></tr></table></figure>
<p>上传整个目录时，所有文件都有其对应的hash，并且每个目录都有其hash，访问某个文件有两种方式：</p>
<ol>
<li>直接通过问价hash访问</li>
<li>通过<code>目录hash/文件名</code>访问</li>
</ol>
<p>IPFS还有很多有趣的地方。例如可以上传一个静态网站到ipfs，并通过浏览器访问，这样就创建了一个永存的网站。往IPFS上传相同的文件，由于hash相同，系统会自动识别，只给后上传的用户建立已有文件的索引，而不是上传一份相同的文件，这样节省很多空间。同时如果一个文件是在另一个文件的基础上修改了写内容而导致hash不同，那么他们相同的内容也不会重复存储，而只是在原文件上拼接不同的部分。总之，IPFS系统有很多高明之处，需要仔细研究。</p>
<h3 id="4、设置跨域"><a href="#4、设置跨域" class="headerlink" title="4、设置跨域"></a>4、设置跨域</h3><p>当我们在前端通过js接口操作ipfs时，会遇到老生常谈的跨域问题，只需终端执行以下配置即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipfs config —json API.HTTPHeaders.Access-Control-Allow-Methods <span class="string">&#x27;[&quot;PUT&quot;,&quot;GET&quot;, &quot;POST&quot;, &quot;OPTIONS&quot;]&#x27;</span></span><br><span class="line">ipfs config —json API.HTTPHeaders.Access-Control-Allow-Origin <span class="string">&#x27;[&quot;*&quot;]&#x27;</span></span><br><span class="line">ipfs config —json API.HTTPHeaders.Access-Control-Allow-Credentials <span class="string">&#x27;[&quot;true&quot;]&#x27;</span></span><br><span class="line">ipfs config —json API.HTTPHeaders.Access-Control-Allow-Headers <span class="string">&#x27;[&quot;Authorization&quot;]&#x27;</span></span><br><span class="line">ipfs config —json API.HTTPHeaders.Access-Control-Expose-Headers <span class="string">&#x27;[&quot;Location&quot;]&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="5、IPFS-与-DAPP-结合"><a href="#5、IPFS-与-DAPP-结合" class="headerlink" title="5、IPFS 与 DAPP 结合"></a>5、IPFS 与 DAPP 结合</h3><p>由于以太坊区块的特性，往区块上存储大文件显然是不合理的。所以通用做法是文件存储到IPFS，之后将文件的hash存储到以太坊区块。当读取时，首先从以太坊区块上取到文件的hash，然后通过hash去IPFS网络上读取文件。</p>
<p>依然使用之前的<code>truffle unbox react</code>创建项目，不同的是只需要多安装一个依赖库<code>ipfs-api</code>，直接<code>cnpm i -S ipfs-api</code>安装即可，显而易见，这就是IPFS系统的js api，这样我们就能在前端调用IPFS的接口上传、读取文件。</p>
<p>话不多说，直接上代码，一个是智能合约，一个是前端react文件，合约交互前几篇已经比较熟悉了，主要看一下怎么通过<code>ipfs-api</code>上传下载文件。一切尽在代码中：</p>
<p>SimpleStorage.sol</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.19;</span><br><span class="line"></span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line"></span><br><span class="line">    string[] public photoArr;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint) storeAddress;</span><br><span class="line"></span><br><span class="line">    function storePhoto(string hash) public &#123;</span><br><span class="line">        if(storeAddress[msg.sender]==0)&#123;</span><br><span class="line">            photoArr.push(hash);</span><br><span class="line">            storeAddress[msg.sender] = 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getPhoto(uint index) public view returns (uint, string)&#123;</span><br><span class="line">        if(photoArr.length==0)&#123;</span><br><span class="line">            return (0, &quot;&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">           return (photoArr.length, photoArr[index]); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isStored() public view returns (bool) &#123;</span><br><span class="line">        if(storeAddress[msg.sender]==0)&#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>App.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123;Component&#125; from &#x27;react&#x27;</span><br><span class="line">import SimpleStorageContract from &#x27;../build/contracts/SimpleStorage.json&#x27;</span><br><span class="line">import getWeb3 from &#x27;./utils/getWeb3&#x27;</span><br><span class="line"></span><br><span class="line">import &#x27;./css/oswald.css&#x27;</span><br><span class="line">import &#x27;./css/open-sans.css&#x27;</span><br><span class="line">import &#x27;./css/pure-min.css&#x27;</span><br><span class="line">import &#x27;./App.css&#x27;</span><br><span class="line"></span><br><span class="line">import ipfsAPI from &#x27;ipfs-api&#x27;</span><br><span class="line">const ipfs = ipfsAPI(&#123;host: &#x27;localhost&#x27;, port: &#x27;5001&#x27;, protocal: &#x27;http&#x27;&#125;)</span><br><span class="line"></span><br><span class="line">const contractAddress = &quot;0x7ebeb83816b74da8173e3f406aeac012cf1718f5&quot;</span><br><span class="line">let simpleStorageInstance</span><br><span class="line"></span><br><span class="line">// Promise 存储文件至ipfs</span><br><span class="line">let saveImageOnIpfs = (reader) =&gt; &#123;</span><br><span class="line">	return new Promise(function (resolve, reject) &#123;</span><br><span class="line">		const buffer = Buffer.from(reader.result);</span><br><span class="line">		ipfs.add(buffer).then((response) =&gt; &#123;</span><br><span class="line">			console.log(response)</span><br><span class="line">			resolve(response[0].hash);</span><br><span class="line">		&#125;)</span><br><span class="line">		.catch((err) =&gt; &#123;</span><br><span class="line">			console.error(err)</span><br><span class="line">			reject(err);</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class App extends Component &#123;</span><br><span class="line">	constructor(props) &#123;</span><br><span class="line">		super(props)</span><br><span class="line"></span><br><span class="line">		this.state = &#123;</span><br><span class="line">			photos: [],</span><br><span class="line">			count: 0,</span><br><span class="line">			web3: null</span><br><span class="line">		&#125;</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  	componentWillMount() &#123;</span><br><span class="line">    	// Get network provider and web3 instance. See utils/getWeb3 for more info.</span><br><span class="line">    	getWeb3.then(results =&gt; &#123;</span><br><span class="line">    		this.setState(&#123;web3: results.web3&#125;)</span><br><span class="line">			this.instantiateContract()</span><br><span class="line">		&#125;).catch(() =&gt; &#123;</span><br><span class="line">			console.log(&#x27;Error finding web3.&#x27;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	instantiateContract() &#123;</span><br><span class="line">		const that = this</span><br><span class="line">		const contract = require(&#x27;truffle-contract&#x27;)</span><br><span class="line">		const simpleStorage = contract(SimpleStorageContract)</span><br><span class="line">		simpleStorage.setProvider(this.state.web3.currentProvider)</span><br><span class="line"></span><br><span class="line">    	this.state.web3.eth.getAccounts((error, accounts) =&gt; &#123;</span><br><span class="line">        	simpleStorage.at(contractAddress).then((instance) =&gt; &#123;</span><br><span class="line">				simpleStorageInstance = instance</span><br><span class="line">			&#125;)</span><br><span class="line">			.then(result =&gt; &#123;</span><br><span class="line">                console.log(&#x27;inint success&#x27;)</span><br><span class="line">				return simpleStorageInstance.getPhoto(0)</span><br><span class="line">			&#125;)</span><br><span class="line">			.then(result =&gt; &#123;</span><br><span class="line">				console.log(result)</span><br><span class="line">				let imgNum = result[0].c[0]</span><br><span class="line">				if(imgNum===0)&#123;</span><br><span class="line">					return</span><br><span class="line">				&#125;</span><br><span class="line">				if(imgNum===1)&#123;</span><br><span class="line">					this.setState(&#123;</span><br><span class="line">						count: imgNum,</span><br><span class="line">						photos: this.state.photos.concat([result[1]])</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;</span><br><span class="line">				if(imgNum&gt;1)&#123;</span><br><span class="line">				    // 闭包，读取存储的所有图片</span><br><span class="line">					for(let i=0;i&lt;imgNum;i++)&#123;</span><br><span class="line">						(function(i)&#123;</span><br><span class="line">							simpleStorageInstance.getPhoto(i)</span><br><span class="line">							.then(result =&gt; &#123;</span><br><span class="line">								that.setState(&#123;</span><br><span class="line">									photos: that.state.photos.concat([result[1]])</span><br><span class="line">								&#125;)</span><br><span class="line">							&#125;)</span><br><span class="line">						&#125;)(i)</span><br><span class="line">					&#125;	</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  	render() &#123;</span><br><span class="line">		let doms = [],</span><br><span class="line">			photos = this.state.photos</span><br><span class="line">		for(let i=0; i&lt;photos.length;i++)&#123;</span><br><span class="line">			doms.push(&lt;div key=&#123;i&#125;&gt;&lt;img src=&#123;&quot;http://localhost:8080/ipfs/&quot; + photos[i]&#125;/&gt;&lt;/div&gt;)</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		return (</span><br><span class="line">			&lt;div className=&quot;App&quot;&gt;</span><br><span class="line">				&lt;header&gt;上传图片至ipfs，并保存信息至以太坊区块&lt;/header&gt;</span><br><span class="line">				&lt;div className=&quot;upload-container&quot;&gt;</span><br><span class="line">					&lt;label id=&quot;file&quot;&gt;选择图片&lt;/label&gt;</span><br><span class="line">					&lt;input type=&quot;file&quot; ref=&quot;file&quot; id=&quot;file&quot; name=&quot;file&quot; multiple=&quot;multip</span><br><span class="line">					le&quot;/&gt;</span><br><span class="line">					&lt;button onClick=&#123;() =&gt; this.upload()&#125;&gt;上传&lt;/button&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">				&lt;div className=&quot;img-container&quot;&gt;</span><br><span class="line">					&#123;doms&#125;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"> 	upload() &#123;</span><br><span class="line">        console.log(&quot;upload&quot;);</span><br><span class="line">        let isStored = false</span><br><span class="line">        simpleStorageInstance.isStored()</span><br><span class="line">        .then(result =&gt; &#123;</span><br><span class="line">            console.log(&quot;is stored&quot;, result)</span><br><span class="line">            if(result) &#123;</span><br><span class="line">                isStored = true</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        if(isStored) &#123;</span><br><span class="line">            alert(&quot;每个钱包地址只能上传一张图片哦😯 ~&quot;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">		var file = this.refs.file.files[0];</span><br><span class="line">		console.log(file)</span><br><span class="line">    	var reader = new FileReader();</span><br><span class="line">		// reader.readAsDataURL(file);</span><br><span class="line">		reader.readAsArrayBuffer(file)</span><br><span class="line">		reader.onloadend = (e) =&gt; &#123;</span><br><span class="line">			//console.log(reader);</span><br><span class="line">			saveImageOnIpfs(reader).then((hash) =&gt; &#123;</span><br><span class="line">				console.log(hash);</span><br><span class="line">                return simpleStorageInstance.storePhoto(hash, &#123;from: this.state.web3.eth.accounts[0]&#125;)</span><br><span class="line">                .then(result =&gt; &#123;</span><br><span class="line">                    console.log(&quot;写入区块成功&quot;, result)</span><br><span class="line">                    this.setState(&#123;</span><br><span class="line">                        photos: this.state.photos.concat([hash])</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default App</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完整代码：<a target="_blank" rel="noopener" href="https://github.com/flute/ipfs_blockchain_dapp">GitHub</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-03-04T15:12:04.000Z" title="3/4/2018, 11:12:04 PM">2018-03-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-03-04T15:15:34.000Z" title="3/4/2018, 11:15:34 PM">2018-03-04</time></span><span class="level-item">4 minutes read (About 635 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/04/%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E2%80%94%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%B0%B8%E5%AD%98%E7%9A%84%E7%95%99%E8%A8%80/">一个完整的智能合约—区块链上永存的留言</a></h1><div class="content"><h4 id="目标："><a href="#目标：" class="headerlink" title="目标："></a>目标：</h4><p>基于以太坊开发一个完整的DAPP应用，实现留言及随机展示留言功能。</p>
<ul>
<li><p>技术栈：使用<code>solidity</code>语言的<code>truffle</code>框架，项目模板使用<code>react</code>，前端使用ES6语法。</p>
</li>
<li><p>项目线上地址： <a target="_blank" rel="noopener" href="http://words.ldsun.com/">http://words.ldsun.com/</a></p>
</li>
<li><p>项目代码：<a target="_blank" rel="noopener" href="https://github.com/flute/blockChainWords">https://github.com/flute/blockChainWords</a></p>
</li>
</ul>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>本次从零开发发哦部署上线约耗时六小时，前期在<code>solidity</code>合约开发上费时较多，主要是对其语言特性不了解，后续在<code>react</code>的动画上有些费时，源于对动画的生疏及类库的选择。<br>整个的开发流程比较清晰：</p>
<ol>
<li>编写、调试合约</li>
<li>编写<code>react</code>前端页面、与合约交互的逻辑、显示逻辑、动画等</li>
<li>部署合约，与前端联调</li>
<li>编译项目，上传代码，配置<code>nginx</code>解析。</li>
</ol>
<h4 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h4><p>整个项目的的实现比较简单，这里不做具体分析，可以git查看，同时参考前几篇文章即可。这里贴一下<code>solidity</code>合约开发中开始的一些“美(错)好(误)想(代)法(码)”：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.19;</span><br><span class="line"></span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line"></span><br><span class="line">    // 定义存储留言的数据结构</span><br><span class="line">    struct Message &#123;</span><br><span class="line">        string word; // 留言</span><br><span class="line">        string time; // 写入时间</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; Message[]) public words; // 以字典形式存储</span><br><span class="line"></span><br><span class="line">    // 写入留言</span><br><span class="line">    function setWord(string s, string t) public &#123;</span><br><span class="line">        if(words[msg.sender].length==0) &#123;</span><br><span class="line">            addrArr.push(msg.sender);</span><br><span class="line">        &#125;</span><br><span class="line">        words[msg.sender].push(Message(&#123;</span><br><span class="line">            word: s,</span><br><span class="line">            time: t</span><br><span class="line">        &#125;));  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取某地址对应的所有留言（获取我的所有留言）</span><br><span class="line">    function getWordByAddress() public view returns (Message[]) &#123;</span><br><span class="line">        return words[msg.sender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 随机返回十条留言</span><br><span class="line">    function getRandomWord() public view returns (Message[]) &#123;</span><br><span class="line">        Message[] memory result;</span><br><span class="line">        for w, i := range words &#123;</span><br><span class="line">            result.push(w)</span><br><span class="line">            if(i==9) break;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对<code>solidity</code>熟悉的大佬应该看完几声冷笑。是的，以下是重点！！！：</p>
<ol>
<li><code>solidity</code>中的字典不支持枚举/遍历</li>
<li><code>solidity</code>中对外暴露的函数不能返回字典/结构体/数组（简单的数字类型数组除外）</li>
</ol>
<p>这两点实在是让我觉得<code>solidity</code>很鸡肋？没有了这两个语言特性，使得智能合约的功能复杂度上限制很大，这或许就是没有“杀手级”应用出现的原因之一。不过话说回来，毕竟<code>solidity</code>还很年轻，相信随着时间推进，这门语言会愈加完善健全。</p>
<h4 id="组织"><a href="#组织" class="headerlink" title="组织"></a>组织</h4><p>喜欢智能合约开发的同志，请加qq交流群 236380268</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-02-22T03:17:42.000Z" title="2/22/2018, 11:17:42 AM">2018-02-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-12-10T09:11:48.000Z" title="12/10/2018, 5:11:48 PM">2018-12-10</time></span><span class="level-item">16 minutes read (About 2355 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/22/%E5%9F%BA%E4%BA%8EReact-truffle%E7%9A%84%E5%AE%8C%E6%95%B4%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%9E%84%E5%BB%BA/">基于React+truffle的完整智能合约构建</a></h1><div class="content"><p>内容：使用solidity的truffle框架开发智能合约，前端使用react框架，最终完成智能合约从前端到后端，从开发到部署的完整流程。</p>
<h3 id="1、truffle安装"><a href="#1、truffle安装" class="headerlink" title="1、truffle安装"></a>1、truffle安装</h3><p>在nodejs安装完成的环境下，全局安装truffle：<code>cnpm i -g truffle</code>。</p>
<p><code>Truffle Boxes</code>是truffle框架集成的脚手架工具，可以使用这个脚手架快捷的生成完备的DAPP的项目结构，其中集成了前端视图、编译压缩工具等。可以在<code>http://truffleframework.com/boxes/</code>中查看并选择合适的模板来进行项目初始化。</p>
<h3 id="2、项目初始化"><a href="#2、项目初始化" class="headerlink" title="2、项目初始化"></a>2、项目初始化</h3><p>这里我在<code>http://truffleframework.com/boxes/</code>上选择<code>react</code>模板来开发DAPP，直接在终端执行<code>truffle unbox React</code>即可完成项目的初始化，期间需要安装nodejs依赖，耐心等待即可（都没个安装进度提示，差评！）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ludis@MacBook -&gt; ~/Desktop/golang -&gt; mkdir truffle &amp;&amp; <span class="built_in">cd</span> truffle</span><br><span class="line">ludis@MacBook -&gt; ~/Desktop/golang/truffle -&gt; truffle unbox React</span><br><span class="line">Downloading...</span><br><span class="line">Unpacking...</span><br><span class="line">Setting up...</span><br></pre></td></tr></table></figure>

<p>项目初始化完成之后，目录结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── box-img-lg.png</span><br><span class="line">├── box-img-sm.png</span><br><span class="line">├── config</span><br><span class="line">│   ├── env.js</span><br><span class="line">│   ├── jest</span><br><span class="line">│   ├── paths.js</span><br><span class="line">│   ├── polyfills.js</span><br><span class="line">│   ├── webpack.config.dev.js</span><br><span class="line">│   └── webpack.config.prod.js</span><br><span class="line">├── contracts</span><br><span class="line">│   ├── Migrations.sol</span><br><span class="line">│   └── SimpleStorage.sol</span><br><span class="line">├── migrations</span><br><span class="line">│   ├── 1_initial_migration.js</span><br><span class="line">│   └── 2_deploy_contracts.js</span><br><span class="line">├── package.json</span><br><span class="line">├── public</span><br><span class="line">│   ├── favicon.ico</span><br><span class="line">│   └── index.html</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── build.js</span><br><span class="line">│   ├── start.js</span><br><span class="line">│   └── test.js</span><br><span class="line">├── src</span><br><span class="line">│   ├── App.css</span><br><span class="line">│   ├── App.js</span><br><span class="line">│   ├── App.test.js</span><br><span class="line">│   ├── css</span><br><span class="line">│   ├── fonts</span><br><span class="line">│   ├── index.css</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── utils</span><br><span class="line">├── <span class="built_in">test</span></span><br><span class="line">│   ├── TestSimpleStorage.sol</span><br><span class="line">│   └── simplestorage.js</span><br><span class="line">├── tmp-8766pK0xGOxZkgsX</span><br><span class="line">│   └── box</span><br><span class="line">├── truffle-config.js</span><br><span class="line">└── truffle.js</span><br></pre></td></tr></table></figure>

<ul>
<li><code>contracts</code>和<code>migrations</code>文件夹上篇已经介绍过，分别为<code>solidity</code>合约文件及相应配置文件。</li>
<li><code>src</code>目录下是<code>react</code>前端代码。</li>
</ul>
<h3 id="3、合约编写、编译和部署"><a href="#3、合约编写、编译和部署" class="headerlink" title="3、合约编写、编译和部署"></a>3、合约编写、编译和部署</h3><p>在项目初始化完成后，有一个默认的合约示例<code>SimpleStorage.sol</code>，我们直接用这个示例做测试：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line">  <span class="keyword">uint</span> storedData;</span><br><span class="line"></span><br><span class="line">  function set(<span class="keyword">uint</span> x) public &#123;</span><br><span class="line">    storedData = x;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function get() public view returns (<span class="keyword">uint</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> storedData;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个合约代码是最简单的读和写两个操作，也是最基础最常用的操作。</p>
<p>编译过程非常简单，在项目根目录下执行<code>truffle compile</code>即可，会在根目录生成<code>build</code>编译目录。这里的编译与部署合约无关，只是为了后续前端代码的调用。</p>
<p>接着将合约部署到以太坊网络上，同理，可以选择部署到正式网络/测试网络/本地，这里我们选择测试网络，部署过程详见<a target="_blank" rel="noopener" href="https://www.ldsun.com/2018/02/06/solidityhe-yue-bu-shu/">区块链学习 - solidity合约部署</a>，小狐狸选择测试网络，将代码粘贴至左侧编辑器，右侧选择对应选项后即可部署成功，部署成功后我们便能得到部署的十六位的合约地址，以我部署的地址<code>0x2dc69582315624fba54ae69655abea27fd48468e</code>为例。</p>
<p><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/bushu.png?imageMogr2/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="合约部署"></p>
<h3 id="4、前端与合约交互"><a href="#4、前端与合约交互" class="headerlink" title="4、前端与合约交互"></a>4、前端与合约交互</h3><p>上步部署完合约后，需要将合约地址记下，后续对合约的所有操作都需要通过合约地址进行。</p>
<p><code>src</code>目录下便是<code>react</code>的前端代码，<code>index.js</code>作为入口文件：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到<code>index.js</code>中将<code>App.js</code>作为主组件引入，打开<code>App.js</code>，头部引用为：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> SimpleStorageContract <span class="keyword">from</span> <span class="string">&#x27;../build/contracts/SimpleStorage.json&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getWeb3 <span class="keyword">from</span> <span class="string">&#x27;./utils/getWeb3&#x27;</span></span><br></pre></td></tr></table></figure>
<p>通过头部引用可以看出前端与合约交互的流程：</p>
<ol>
<li>首先前端使用了<code>react</code>框架；</li>
<li>第二句<code>import SimpleStorageContract from &#39;../build/contracts/SimpleStorage.json&#39;</code>导入的实际上是上步合约代码编译后产生的<code>json</code>文件，该文件中包含两个重要信息：一个是<code>abi</code>字段，通俗讲就是合约代码编译后产生的二进制接口，其中会声明合约代码暴露的可供调用的接口；另一个是<code>bytecode</code>字段，为合约代码的十六进制码。通过这两个重要信息就可以对一个合约进行相应操作。</li>
<li>导入了<code>web3.js</code>，<code>web3.js</code>是以太坊提供的一个JavaScript库，他封装了以太坊的<code>JSON RPC API</code>，提供了一系列与区块链交互的JavaScript对象和函数，包括查看网络状态，查看本地账户、查看交易和区块、发送交易、编译/部署智能合约、调用智能合约等，其中最重要的就是与智能合约交互的API。</li>
</ol>
<p>明白了前端与合约交互的原理，剩下来的就是使用<code>react</code>语法结合<code>web3.js</code>提供的接口对合约操作即可。</p>
<p>将<code>App.js</code>文件进行一些修改，实现：在网页输入框中输入值，点击确定后可以修改合约中的值（写操作），写入成功后读取合约中的新值，并自动显示到网页（读操作）,也就是通过前端网页对上述合约中定义的的<code>set()</code>和<code>get()</code>两个方法的调用。</p>
<p>最终App.js如下，主要修改分以下几点:</p>
<ul>
<li>将部署完成的合约地址作为变量<code>contractAddress</code>保存，以供后续调用合约使用。</li>
<li>声明<code>simpleStorageInstance</code>变量，作用是通过合约地址得到合约实例后将合约实例保存起来，方便后续调用。</li>
<li>添加输入框及按钮，点击按钮时读取输入框的值，通过合约实例及web3提供的方法修改合约中的<code>storedData</code>值。</li>
<li>使用<code>Promise</code>语法，当写操作成功后，执行读操作，并在读取成功后，修改<code>react</code>的组件状态<code>state</code>中的变量值，使前端显示自动更新</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> SimpleStorageContract <span class="keyword">from</span> <span class="string">&#x27;../build/contracts/SimpleStorage.json&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getWeb3 <span class="keyword">from</span> <span class="string">&#x27;./utils/getWeb3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./css/oswald.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./css/open-sans.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./css/pure-min.css&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./App.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> contractAddress = <span class="string">&quot;0x2dc69582315624fba54ae69655abea27fd48468e&quot;</span>; <span class="comment">// 合约地址</span></span><br><span class="line"><span class="keyword">var</span> simpleStorageInstance; <span class="comment">// 合约实例</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(props)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.state = &#123;</span><br><span class="line">            <span class="attr">storageValue</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">web3</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Get network provider and web3 instance.</span></span><br><span class="line">        <span class="comment">// See utils/getWeb3 for more info.</span></span><br><span class="line"></span><br><span class="line">        getWeb3</span><br><span class="line">        .then(<span class="function"><span class="params">results</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">                <span class="attr">web3</span>: results.web3</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Instantiate contract once web3 provided.</span></span><br><span class="line">            <span class="built_in">this</span>.instantiateContract()</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Error finding web3.&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">instantiateContract</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * SMART CONTRACT EXAMPLE</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Normally these functions would be called in the context of a</span></span><br><span class="line"><span class="comment">         * state management library, but for convenience I&#x27;ve placed them here.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> contract = <span class="built_in">require</span>(<span class="string">&#x27;truffle-contract&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> simpleStorage = contract(SimpleStorageContract)</span><br><span class="line">        simpleStorage.setProvider(<span class="built_in">this</span>.state.web3.currentProvider)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declaring this for later so we can chain functions on SimpleStorage.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get accounts.</span></span><br><span class="line">        <span class="built_in">this</span>.state.web3.eth.getAccounts(<span class="function">(<span class="params">error, accounts</span>) =&gt;</span> &#123;      </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取合约地址获取合约实例并保存</span></span><br><span class="line">        simpleStorage.at(contractAddress).then(<span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">                simpleStorageInstance = instance</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Stores a given value, 5 by default.</span></span><br><span class="line">                <span class="comment">// return simpleStorageInstance.set(5, &#123;from: accounts[0]&#125;)</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// Get the value from the contract to prove it worked.</span></span><br><span class="line">                <span class="keyword">return</span> simpleStorageInstance.get.call(accounts[<span class="number">0</span>])</span><br><span class="line">            &#125;).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// Update state with the result.</span></span><br><span class="line">                <span class="built_in">console</span>.log(result);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">storageValue</span>: result.c[<span class="number">0</span>] &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">nav</span> <span class="attr">className</span>=<span class="string">&quot;navbar pure-menu pure-menu-horizontal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">className</span>=<span class="string">&quot;pure-menu-heading pure-menu-link&quot;</span>&gt;</span>Truffle Box<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">main</span> <span class="attr">className</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;pure-g&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;pure-u-1-1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Good to Go!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Your Truffle Box is installed and ready.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Smart Contract Example<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>If your contracts compiled and migrated successfully, below will show a stored value of 5 (by default).<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Try changing the value stored on <span class="tag">&lt;<span class="name">strong</span>&gt;</span>line 59<span class="tag">&lt;/<span class="name">strong</span>&gt;</span> of App.js.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>The stored value is: &#123;this.state.storageValue&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&quot;myvalue&quot;</span> <span class="attr">className</span>=<span class="string">&quot;myinput&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">className</span>=<span class="string">&quot;mybutton&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                    <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="xml">                        var num = Number(this.refs.myvalue.value);</span></span><br><span class="line"><span class="xml">                        console.log(&quot;点击了button&quot;);</span></span><br><span class="line"><span class="xml">                        console.log(num);</span></span><br><span class="line"><span class="xml">                        simpleStorageInstance.set(num, &#123;from: this.state.web3.eth.accounts[0]&#125;).then(() =&gt; &#123;</span></span><br><span class="line"><span class="xml">                            console.log(&quot;数据修改成功&quot;);</span></span><br><span class="line"><span class="xml">                            simpleStorageInstance.get.call(this.state.web3.eth.accounts[0]).then((result) =&gt; &#123;</span></span><br><span class="line"><span class="xml">                                console.log(&quot;数据读取成功&quot;);</span></span><br><span class="line"><span class="xml">                                console.log(result);</span></span><br><span class="line"><span class="xml">                                // 修改状态变量的值，在react中，一旦状态变量的值发生变化，就会调用render函数重新渲染UI</span></span><br><span class="line"><span class="xml">                                this.setState(&#123; storageValue: result.c[0] &#125;)</span></span><br><span class="line"><span class="xml">                            &#125;);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                        &#125;)</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">                    &#125;&#125;</span></span><br><span class="line"><span class="xml">                    style=&#123;&#123;height: 40,marginLeft: 50&#125;&#125;&gt;修改合约数据<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App</span><br></pre></td></tr></table></figure>

<h3 id="5、启动项目，查看效果"><a href="#5、启动项目，查看效果" class="headerlink" title="5、启动项目，查看效果"></a>5、启动项目，查看效果</h3><p>启动本地的<code>react</code>项目，直接终端执行<code>npm start</code>即可。会用<code>node</code>在本地启一个3000端口的服务，浏览器会自动跳转到<code>http://localhost:3000</code>，就会显示<code>react</code>编写的前端页面，在输入框修改相应数值，点击确定，然后小狐狸会弹出支付提示（记得小狐狸切换到测试网络）（所有的写操作均需要支付手续费），确认支付后耐心等待被打包成功，就能看到网页上数值的变化了。</p>
<p><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/images/react.png?imageMogr2/blur/1x0/quality/75%7Cwatermark/1/image/aHR0cHM6Ly9vYzhwcnRlcXUucW5zc2wuY29tL2ltYWdlcy93YXRlcm1hcmsucG5n/dissolve/100/gravity/SouthEast/dx/10/dy/10%7Cimageslim" alt="本地测试"></p>
<h3 id="6、总结"><a href="#6、总结" class="headerlink" title="6、总结"></a>6、总结</h3><p>一个完整的覆盖前后端的DAPP实际上就两点，跟传统互联网项目的前后端类似：</p>
<ol>
<li>合约编写、部署</li>
<li>前端调用</li>
</ol>
<p>基于以太坊开发DAPP实际上比较简单，重点是在合约的逻辑性、安全性上。从这也可以看出来以太坊生态的强大和完整，便捷完备的开发语言、工具，确实是目前继大饼之后最牛的项目。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-02-06T19:31:38.000Z" title="2/7/2018, 3:31:38 AM">2018-02-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-02-20T03:22:01.000Z" title="2/20/2018, 11:22:01 AM">2018-02-20</time></span><span class="level-item">10 minutes read (About 1550 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/07/solidity%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B%E5%8F%8Atruffle%E4%BD%BF%E7%94%A8/">solidity函数类型及truffle使用</a></h1><div class="content"><h2 id="1、solidity类的多继承、重写"><a href="#1、solidity类的多继承、重写" class="headerlink" title="1、solidity类的多继承、重写"></a>1、<code>solidity</code>类的多继承、重写</h2><p><code>solidity</code>类具有多继承的特性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.19</span><br><span class="line"></span><br><span class="line">contract Animal1 &#123;</span><br><span class="line">    uint age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Animal2 &#123;</span><br><span class="line">    string weight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Dog is Animal1, Animal2 &#123;</span><br><span class="line">    /** Dog 会继承 Animal1 及 Animal2 两个类 */</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>重写</strong>与其他语言相通，即子类的同名函数会覆盖从父类继承的方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^ <span class="number">0.4</span> <span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line">contract Animal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testFunc</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Animal testFunc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 子类重写了从父类继承过来的方法，会以子类的方法为基准 */</span></span><br><span class="line">contract Dog is Animal &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testFunc</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Dog testFunc&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、solidity函数的访问权限"><a href="#2、solidity函数的访问权限" class="headerlink" title="2、solidity函数的访问权限"></a>2、<code>solidity</code>函数的访问权限</h2><p><code>solidity</code>函数分为四种访问权限：</p>
<ul>
<li><code>private</code>:  私有函数。内部正常访问，外部无法访问，子类无法继承。</li>
<li><code>internal</code>: 内部函数。内部正常访问，外部无法访问，子类可继承。</li>
<li><code>public</code>:   公共函数。内部正常访问，外部正常访问，子类可继承。</li>
<li><code>external</code>: 外部函数。内部不能访问，外部正常访问，子类可继承。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line">contract Animal &#123;</span><br><span class="line">    <span class="comment">/** public  公有：外部、内部、子类都可使用 */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testPublic</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;public&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** private 私有：合约内部可以正常访问 */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testPrivate</span>(<span class="params"></span>) <span class="title">private</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;private&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** internal 内部：合约内部可以正常访问 */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testInternal</span>(<span class="params"></span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;internal&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** external 外部：只能供外部访问 */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">testExternal</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;external&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** 未做任何修改时，使用pure */</span> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> </span>&#123;</span><br><span class="line">        testPublic();</span><br><span class="line">        testInternal();</span><br><span class="line">        testPrivate();</span><br><span class="line">        <span class="comment">//testExternal(); // 报错，只能供外部访问</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Dog is Animal &#123;</span><br><span class="line">    <span class="comment">/** 继承 public、internal、external 类型的函数 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dog.testPublic() 继承，可用</span></span><br><span class="line"><span class="comment">// Dog.testInternal() 继承，不可用（internal函数外部无法访问）</span></span><br><span class="line"><span class="comment">// Dog.testExternal() 继承，可用</span></span><br><span class="line"><span class="comment">// Dog.f() 继承，可用</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="3、solidity函数中pure、view、constant的区别"><a href="#3、solidity函数中pure、view、constant的区别" class="headerlink" title="3、solidity函数中pure、view、constant的区别"></a>3、<code>solidity</code>函数中<code>pure</code>、<code>view</code>、<code>constant</code>的区别</h2><p><code>solidity</code>函数的完整声明格式为：</p>
<pre class="text">function 函数名(参数)  public|private|internal|external  pure|view|constant  无返回值|returns (返回值类型)
</pre>

<p>首先来个测试案例，根据编辑器提示补齐函数类型，然后总结不同之处：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line">contract Animal &#123;</span><br><span class="line">    string homeAddress = <span class="string">&quot;北京市&quot;</span>;</span><br><span class="line">    uint weight;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** pure */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getAge</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** view */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getCurrentAddress</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** view */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getHomeAddress</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> homeAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setWeight</span>(<span class="params">uint w</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        weight = w;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** constant/view都行 */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getWeight</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        weight = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">return</span> weight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结论如下：</p>
<ul>
<li>只有当函数有返回值的情况下，才需要使用<code>pure</code>、<code>view</code>、<code>constant</code></li>
<li><code>pure</code>: 当函数返回值为自变量而非变量时，使用<code>pure</code></li>
<li><code>view</code>: 当函数返回值为全局变量或属性时，使用<code>view</code></li>
<li><code>constant</code>: 可以理解为<code>view</code>的旧版本，与<code>view</code>是等价的</li>
</ul>
<p>如果一个函数有返回值，函数中正常来讲需要有 <code>pure</code>、<code>view</code>或<code>constant</code>关键字，如果没有，在调用函数的过程中，需要主动去调用底层的call方法。</p>
<p><strong>注：</strong>如果一个函数中带了关键字<code>view</code>或<code>constant</code>，就不能修改状态变量的值。但凡是是带了这两个关键字，区块链就默认只是向区块链读取数据，读取数据不需要花gas，但是不花gas就不可能修改状态变量的值。写入数据或者是修改状态变量的值都需要花费gas。</p>
<h2 id="4、truffle初识"><a href="#4、truffle初识" class="headerlink" title="4、truffle初识"></a>4、truffle初识</h2><p><code>truffle</code>是以太坊<code>solidity</code>编程语言的开发框架。</p>
<p>1.安装<code>truffle</code></p>
<p><code>cnpm i -g truffle</code></p>
<p>2.创建项目工程</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> truffle &amp;&amp; <span class="keyword">cd</span> truffle</span><br><span class="line">truffle init</span><br></pre></td></tr></table></figure>

<p>3.项目结构<br><code>contracts</code>目录下存的是<code>solidity</code>合约代码<br><code>migrations</code>中存的是js脚本<br><code>test</code>中存的是测试用例</p>
<p>4.编写代码、部署、调试<br><code>contracts</code>中新建<code>Hello.sol</code>文件，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.17</span>;</span><br><span class="line"></span><br><span class="line">contract Hello &#123;</span><br><span class="line"></span><br><span class="line">    string weight = <span class="string">&quot;18cm&quot;</span>;</span><br><span class="line">    string height = <span class="string">&quot;180cm&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getAge</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getWeight</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  weight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">constant</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">250</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>类名<code>Hello</code>需要跟文件名<code>Hello.sol</code>保存一致</li>
<li><code>Migrations.sol</code>文件不能删除</li>
</ul>
<p>然后在<code>migrations</code>目录下添加对应的js脚本<code>2_depoly_hello.js</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var myHello = artifacts.require(&quot;./Hello.sol&quot;);</span><br><span class="line"></span><br><span class="line">module.exports = function(deployer) &#123;</span><br><span class="line">  deployer.deploy(myHello);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>代码添加完后，打开终端，切换到项目所在路径，执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//启动测试网络</span><br><span class="line">truffle develop</span><br><span class="line"></span><br><span class="line">//编译</span><br><span class="line">compile</span><br><span class="line"></span><br><span class="line">//将合约部署到本地测试网络，成功后会返回合约地址(如:0x75c35c980c0d37ef46df04d31a140b65503c0eed)</span><br><span class="line">migrate </span><br><span class="line"></span><br><span class="line">//通过合约地址，得到合约对象，赋值给变量c</span><br><span class="line">var c;</span><br><span class="line">Hello.at(<span class="string">&#x27;0x75c35c980c0d37ef46df04d31a140b65503c0eed&#x27;</span>).<span class="keyword">then</span>((obj) =&gt; &#123;</span><br><span class="line">    c = obj;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">//调用合约暴露的方法</span><br><span class="line">c.getAge()</span><br><span class="line"></span><br><span class="line">//如果合约中暴露出的有返回值的函数，没有用 pure/view/constant 声明，则需要调用底层的 call 方法才能调用方法</span><br><span class="line">//如上面代码中的<span class="built_in">test</span>方法</span><br><span class="line">c.test.call()</span><br><span class="line"></span><br><span class="line">//修改完代码，编译后，重新部署时需重置之前的合约</span><br><span class="line">migrate --reset</span><br></pre></td></tr></table></figure>

<p><strong>补充：</strong>调用<code>migrate</code>编译之后会<code>build</code>文件夹，存储的是编译之后生成的<code>json</code>文件，而这个<code>json</code>文件就是合约部署在虚拟机中的形式。</p>
<p>编译生成的的<code>json</code>文件中，有两个重要的额键值：</p>
<p><code>abi</code>：通俗讲，<code>abi</code>与<code>api</code>类似，都是<strong>接口</strong>。<code>abi</code>是合约的二进制接口。</p>
<p><code>bytecode</code>：是合约代码的16进制码</p>
<p>通过<code>abi</code>及<code>bytecode</code>就能完成合约的部署。</p>
<h2 id="5、基本值类型、引用类型"><a href="#5、基本值类型、引用类型" class="headerlink" title="5、基本值类型、引用类型"></a>5、基本值类型、引用类型</h2><p><code>uint</code>为值类型，只能深拷贝<br><code>string</code>为引用类型，既可以深拷贝，也可以浅拷贝</p>
<p><code>uint</code>及<code>string</code>深拷贝（默认的声明方式即为深拷贝）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">string a = &quot;100&quot;;</span><br><span class="line">uint b = 100;</span><br><span class="line"></span><br><span class="line">// 浅拷贝</span><br><span class="line">// string aa 等同于 string memory aa</span><br><span class="line">function m(string aa) private &#123;</span><br><span class="line">    aa = &quot;1000&quot;;</span><br><span class="line">&#125;</span><br><span class="line">function n(uint bb) private &#123;</span><br><span class="line">    bb = 1000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function f() public &#123;</span><br><span class="line">    m(a)</span><br><span class="line">    n(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>string</code>类型浅拷贝（加<code>storage</code>关键字）:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">string a = <span class="string">&quot;100&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    m(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 深拷贝</span></span><br><span class="line"><span class="comment">// memory（深拷贝）、 storage（浅拷贝）</span></span><br><span class="line"><span class="comment">// 当函数参数为 storage 类型时，函数类型只能为 private 或 internal，否则报错</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params">string storage aa</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    <span class="comment">//aa = &quot;1000&quot;; // string不能直接修改，需要转换为可变的字节数组</span></span><br><span class="line">    bytes(aa)[<span class="number">0</span>] = <span class="string">&#x27;6&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getA</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-02-05T19:07:05.000Z" title="2/6/2018, 3:07:05 AM">2018-02-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-12-10T09:10:53.000Z" title="12/10/2018, 5:10:53 PM">2018-12-10</time></span><span class="level-item">9 minutes read (About 1376 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/06/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0-solidity%E5%90%88%E7%BA%A6%E9%83%A8%E7%BD%B2/">区块链学习 - solidity合约部署</a></h1><div class="content"><h3 id="区块链原理"><a href="#区块链原理" class="headerlink" title="区块链原理"></a>区块链原理</h3><p>通过<code>https://anders.com/blockchain/hash.html</code>可以直观的了解<code>hash</code>、<code>block</code>（区块）、<code>blockchain</code>（区块链）、<code>distributed</code>（分布）、<code>tokens</code>（代币）各个概念。</p>
<h3 id="开发环境配置"><a href="#开发环境配置" class="headerlink" title="开发环境配置"></a>开发环境配置</h3><h4 id="1、-MetaMask钱包"><a href="#1、-MetaMask钱包" class="headerlink" title="1、 MetaMask钱包"></a>1、 <code>MetaMask</code>钱包</h4><p><strong>1.<code>MetaMask</code>是什么？</strong></p>
<p><code>MetaMask</code>是一款在谷歌浏览器<code>Chrome</code>上使用的插件类型的以太坊钱包，该钱包不需要下载，只需要在谷歌浏览器添加对应的扩展程序即可，非常轻量级，使用起来也非常方便。</p>
<p><strong>2.<code>MetaMask</code>安装</strong></p>
<p><code>chrome</code>浏览器安装<code>MetaMask</code>，直接用<code>MetaMask</code>创建钱包或者通过<code>myetherwallet.com</code>创建钱包，然后用<code>MetaMask</code>导入钱包私钥即可。<br>开发测试时，最好新建一个测试钱包，万一自己的币搞没就裂了~~</p>
<p><strong>3.<code>MetaMask</code>常用功能</strong></p>
<p><img src="https://ludis-1252396698.cos.ap-beijing.myqcloud.com/ghost/Matemask.png"><br>如上图所示，第一个为正式网络，也就是<code>ETH</code>的公链，真实的币就存在公链上。后两个是两个测试网络，点击后便会切换到测试网络，钱包的地址也会随之改变。为了测试方便，在测试网络的钱包中免费获取一些测试用的代币。</p>
<p><strong>4.测试代币获取</strong></p>
<p>在<code>Ropsten Test Network</code>测试网络下，点击<code>BUY</code>-&gt;<code>ROPSTEN TEST  FAUCET</code>会跳转到<code>https://faucet.metamask.io/</code>页面，可以请求获取测试用的<code>eth</code>代币，也可以给别人发送测试代币。操作完成后钱包会显示相应的测试代币数量。</p>
<p>在<code>Kovan Test Network</code>测试网络下，获取测试代币的方式是：加入<code>gitter</code>中的<code>faucet</code>组织，链接为<code>https://gitter.im/kovan-testnet/</code>。加入后，<code>MateMask</code>钱包在<code>Kovan Test Network</code>测试网络下，复制当前测试环境下的钱包地址，然后在<code>gitter</code>的社区中，发送自己的钱包地址（@管理员<code>epheph</code>），这位雷锋大兄弟会给你的钱包发送5个测试代币，最后别忘了来句日常感谢~</p>
<h4 id="2、solidity开发环境配置"><a href="#2、solidity开发环境配置" class="headerlink" title="2、solidity开发环境配置"></a>2、<code>solidity</code>开发环境配置</h4><p><code>atom</code>编辑器安装以下两个插件：<br><code>autocomplete-solidity</code><br><code>language-ethereum</code></p>
<h4 id="3、solidity代码示例"><a href="#3、solidity代码示例" class="headerlink" title="3、solidity代码示例"></a>3、<code>solidity</code>代码示例</h4><p><code>solidity</code>代码文件后缀为<code>.sol</code><br>以下是完整的，最简单的<code>solidity</code>合约代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">// pragam 关键字</span><br><span class="line">// solidity 当前语言</span><br><span class="line">// 0.4 主版本</span><br><span class="line">// .19 副版本</span><br><span class="line">// ^向上兼容，solidity （0.4.19~0.4.99）都可以编译，0.5则不能编译</span><br><span class="line">pragam solidity ^0.4.19;</span><br><span class="line"></span><br><span class="line">// construct 关键字声明类</span><br><span class="line">contract Person &#123;</span><br><span class="line">    uint age = 0; // 默认类型为internal</span><br><span class="line">    string internal name = &quot;佩奇&quot;;</span><br><span class="line">    string public homeAddress = &quot;北京市朝阳区&quot;;    // public声明的属性，会自动生成同名的get函数，返回该属性值</span><br><span class="line">    string private company = &quot;孔壹学院&quot;;</span><br><span class="line">    </span><br><span class="line">    // 构造函数，与类名同名，首次初始化时调用</span><br><span class="line">    function Person() public &#123;</span><br><span class="line">        age = 18;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // set方法</span><br><span class="line">    function setCompany(uint a) public &#123;</span><br><span class="line">        age = a;</span><br><span class="line">    &#125;</span><br><span class="line">    // get方法</span><br><span class="line">    function getCompany() view public returns (uint) &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getCurrentAddres() view public returns (address) &#123;</span><br><span class="line">        // msg.sender 返回当前操作合约的钱包的地址</span><br><span class="line">        return msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 普通函数</span><br><span class="line">    function kill() public&#123;</span><br><span class="line">        // 析构函数，调用时销毁当前合约</span><br><span class="line">        selfdestruct(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ChildPerson is Person &#123;</span><br><span class="line">    function test() public &#123;</span><br><span class="line">        age = 100;</span><br><span class="line">        name = &quot;AWM&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>solidity</code>代码中一定要加<code>;</code>！！！！！！，包括第一句<code>pragam solidity ^0.4.19;</code></p>
<pre class="text">
属性访问权限：
public：
1.会生成一个和属性名同名的get函数，这个函数返回属性自己
2.合约内部可直接访问
3.子类可继承属性

internal：
1.合约内部可直接访问in
2.子类可继承属性

private：
1.合约内部可直接访问
</pre>

<h4 id="4、部署合约"><a href="#4、部署合约" class="headerlink" title="4、部署合约"></a>4、部署合约</h4><ol>
<li><p>打开<code>http://remix.ethereum.org/</code>网站，<code>url</code>后会自动补齐当前最先版的<code>solidity``sdk</code>版本，注意自己写的代码向上兼容性。</p>
</li>
<li><p>将上述代码直接粘贴到左侧编辑器中，会自动编译查错，正常编译通过后，可以在右侧面板点击<code>run</code>选项。各选项解释如下：</p>
<ul>
<li><p><code>Environment</code>指合约要部署的网路环境，<code>JavaScript VM</code>是本地的测试网络；<code>injected Web3</code>是发布到公链。</p>
</li>
<li><p><code>Account</code>指部署合约的钱包地址，因为部署合约需要往公链上写数据，所以需要消耗代币。选择本地测试网络的话，有默认的五个免费的钱包，里面各有100以太币。选择部署到公链的话，通过选择<code>MateMask</code>的网络环境（主网或两个测试网络），<code>Account</code>会显示对应的网络环境下的钱包地址（钱包中必须要有代币才行）</p>
</li>
<li><p><code>Gas limit</code>和<code>Value</code>默认即可</p>
</li>
</ul>
</li>
<li><p>完后下方可以选择<code>solidity</code>代码中声明的类，也就是我们要部署到网络中的类，对应上述代码就是<code>Person</code>和<code>ChildPerson</code>两个类选择其一。</p>
</li>
<li><p>之后点击<code>create</code>，支付完所需的代币手续费后，等待部署完成即可，部署成功后便可以在下方看到<strong>合约的地址</strong>信息，及合约中暴露出来的各种方法，如<code>getAge</code>、<code>setAge</code>等，可以调用这些方法从部署在网络上的合约中写入数据（花费代币）及读取数据（免费），调用<code>kill</code>方法时会执行析构函数<code>selfdestruct</code>，从网络中销毁合约。</p>
</li>
</ol>
<p>至此，一个简单的合约，从代码编写到部署上线的整套流程结束。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-01-31T20:16:18.000Z" title="2/1/2018, 4:16:18 AM">2018-02-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2018-02-13T07:06:18.000Z" title="2/13/2018, 3:06:18 PM">2018-02-13</time></span><span class="level-item">6 minutes read (About 850 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/01/Golang-channel%E8%BF%9B%E9%98%B6/">Golang channel进阶</a></h1><div class="content"><p>将向管道中写入数据的称为“生产者”，从管道中读取数据的称为“消费者”。</p>
<h3 id="1、生产者与消费者关系"><a href="#1、生产者与消费者关系" class="headerlink" title="1、生产者与消费者关系"></a>1、生产者与消费者关系</h3><p>在上篇文章中，生产者与消费者是<code>1:1</code>及<code>n:1</code>的关系，那么能不能实现<code>1:n</code>的关系嘞？即一个生产者向管道添加数据，多个消费者从管道读取？示例如下：</p>
<p><code>1:2</code>案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 生产者 对 消费者 ：1 -&gt; 2</span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">	c := make(chan int)</span><br><span class="line">	done := make(chan bool)</span><br><span class="line"></span><br><span class="line">	// 生产者：大黄</span><br><span class="line">	go func() &#123;</span><br><span class="line">		for i := 0; i &lt; 100; i++ &#123;</span><br><span class="line">			fmt.Println(&quot;生成者 大黄：&quot;, i)</span><br><span class="line">			c &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		close(c)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	// 消费者：小明</span><br><span class="line">	go func() &#123;</span><br><span class="line">		// range 会一直不断检测c管道中的数据，如果有，读取，否则等待，直到显示的close关闭通道</span><br><span class="line">		for n := range c &#123;</span><br><span class="line">			fmt.Println(&quot;消费者：小明:&quot;, n)</span><br><span class="line">		&#125;</span><br><span class="line">		done &lt;- true</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	// 消费者：大明</span><br><span class="line">	go func() &#123;</span><br><span class="line">		// n 等价于 &lt;-c</span><br><span class="line">		for n := range c &#123;</span><br><span class="line">			fmt.Println(&quot;消费者：大明:&quot;, n)</span><br><span class="line">		&#125;</span><br><span class="line">		done &lt;- true</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	&lt;-done</span><br><span class="line">	&lt;-done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改上述案例，实现<code>1:n</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生产者 对 消费者 ：1 -&gt; n</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">	done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">	n := <span class="number">10</span></span><br><span class="line">	<span class="comment">// 生产者：大黄</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;生成者生产数据:&quot;</span>, i)</span><br><span class="line">			c &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">close</span>(c)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">		<span class="comment">// 消费者：小明</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			<span class="comment">// range 会一直不断检测c管道中的数据，如果有，读取，否则等待，直到显示的close关闭通道</span></span><br><span class="line">			<span class="keyword">for</span> n := <span class="keyword">range</span> c &#123;</span><br><span class="line">				fmt.Println(<span class="string">&quot;消费者&quot;</span>,idx,<span class="string">&quot;消费数据:&quot;</span>, n)</span><br><span class="line">			&#125;</span><br><span class="line">			done &lt;- <span class="literal">true</span></span><br><span class="line">		&#125;(i)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">		&lt;-done</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在循环创建消费者分线程时，使用闭包特性，将<code>i</code>值保存在分线程中。</p>
<h3 id="2、封装channel"><a href="#2、封装channel" class="headerlink" title="2、封装channel"></a>2、封装<code>channel</code></h3><p>为了提高代码可读性、复用性，便于维护，可以将<code>channel</code>封装于函数方法中，<code>channel</code>可作为函数的参数或返回值，示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">// 生产者和消费者一定是配对的状态</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	// c是一个管道</span><br><span class="line">	c := incrementor() //把管道作为返回值</span><br><span class="line">	cSum := puller(c)  //把管道作为参数</span><br><span class="line">	for n := range cSum &#123;</span><br><span class="line">		fmt.Println(n) // 0 ...9</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 类型：func () chan int</span><br><span class="line">// chan int 返回值类型</span><br><span class="line">func incrementor() chan int &#123;</span><br><span class="line">	// 创建一个管道</span><br><span class="line">	out := make(chan int)</span><br><span class="line">	// 通过主线程创建一个分线程</span><br><span class="line">	go func() &#123; //子线程</span><br><span class="line">		for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">			out &lt;- i //生产数据</span><br><span class="line">		&#125;</span><br><span class="line">		close(out)</span><br><span class="line">	&#125;()</span><br><span class="line">	// 返回out管道</span><br><span class="line">	return out</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 函数类型：func (chan int) chan int</span><br><span class="line">// 返回值类型：chan int</span><br><span class="line">// 参数类型：chan int</span><br><span class="line">func puller(c chan int) chan int &#123;</span><br><span class="line">	// 创建一个新的管道</span><br><span class="line">	out := make(chan int)</span><br><span class="line">	// 创建一个子线程</span><br><span class="line">	go func() &#123;</span><br><span class="line">		var sum int</span><br><span class="line"></span><br><span class="line">		// &lt;-c</span><br><span class="line">		// 通过range取读取管道c里面的数据，这个for跳出循环的时间为管道c被关闭</span><br><span class="line">		for n := range c &#123;</span><br><span class="line">			sum += n</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// out &lt;- sum 什么时候执行？</span><br><span class="line">		out &lt;- sum //生产者</span><br><span class="line">		close(out)</span><br><span class="line">	&#125;()</span><br><span class="line">	return out</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3、单向管道、双向管道"><a href="#3、单向管道、双向管道" class="headerlink" title="3、单向管道、双向管道"></a>3、单向管道、双向管道</h3><p><strong>双向通道：</strong><br>前面我们以<code>var c chan int</code>形式声明的通道，即类型为<code>chan type</code>的<code>channel</code>都是双向通道。双向通道顾名思义，就是能存数据又能读数据<br><strong>单向通道：</strong><br>单向通道，就是只能存或只能读的<code>channel</code><br>声明单向通道：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var readChan &lt;-chan int // 只读的channel</span><br><span class="line">var c WriteChan&lt;- int // 只写的channel</span><br><span class="line"></span><br><span class="line">readChan &lt;- 1  // 报错</span><br><span class="line">&lt;-writeChan    // 报错</span><br></pre></td></tr></table></figure>
<p>对只读的管道执行写操作、对只写的管道执行读操作都会报错。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/2/">Previous</a></div><div class="pagination-next"><a href="/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link is-current" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/18/">18</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://img.ikstatic.cn/MTYzMTE3MTU3NDM3MCM1MzYjcG5n.png" alt="Ludis"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Ludis</p><p class="is-size-6 is-block">Valar Morghulis, Valar Dohaeris</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">177</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">17</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/flute" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/flute"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/3852099619"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:552452006@qq.com"><i class="far fa-envelope"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-06-30T07:42:16.000Z">2021-06-30</time></p><p class="title"><a href="/2021/06/30/React-Antd-Warning%E7%A7%BB%E9%99%A4%E5%A4%A7%E6%B3%95%E2%80%94%E2%80%94%E6%95%B4%E4%B8%AA%E4%B8%96%E7%95%8C%E6%B8%85%E5%87%80%E4%BA%86/">React/Antd Warning移除大法——整个世界清净了</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-05-14T10:41:14.000Z">2020-05-14</time></p><p class="title"><a href="/2020/05/14/IntersectionObserver/">IntersectionObserver</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-02-06T13:45:55.000Z">2020-02-06</time></p><p class="title"><a href="/2020/02/06/%E5%BE%AE%E5%B1%81%E6%81%A9%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%E4%B9%8B-%E2%80%94%E2%80%94-V2Ray/">微屁恩使用指南之 —— V2Ray</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-12-10T07:45:26.000Z">2019-12-10</time></p><p class="title"><a href="/2019/12/10/H5%E5%9C%A8%E5%85%A8%E5%B1%8FWebview%E4%B8%AD%E5%8F%8C%E7%AB%AF%E9%80%82%E9%85%8D%E5%88%98%E6%B5%B7%E5%B1%8F/">H5在全屏Webview中双端适配刘海屏</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-07-25T09:58:45.000Z">2019-07-25</time></p><p class="title"><a href="/2019/07/25/vue-%E9%A1%B9%E7%9B%AE%E5%9C%A8%E4%BD%8E%E9%85%8D%E6%9C%BA%E5%99%A8%E4%B8%8A%E7%BA%BF%E5%8F%8A%E4%BC%98%E5%8C%96/">vue 项目在低配机器上线及优化</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">December 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/02/"><span class="level-start"><span class="level-item">February 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">December 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/10/"><span class="level-start"><span class="level-item">October 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">September 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/06/"><span class="level-start"><span class="level-item">June 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/05/"><span class="level-start"><span class="level-item">May 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">March 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/12/"><span class="level-start"><span class="level-item">December 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/11/"><span class="level-start"><span class="level-item">November 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/10/"><span class="level-start"><span class="level-item">October 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/09/"><span class="level-start"><span class="level-item">September 2016</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/08/"><span class="level-start"><span class="level-item">August 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/07/"><span class="level-start"><span class="level-item">July 2016</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/02/"><span class="level-start"><span class="level-item">February 2016</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/12/"><span class="level-start"><span class="level-item">December 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/11/"><span class="level-start"><span class="level-item">November 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/10/"><span class="level-start"><span class="level-item">October 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/09/"><span class="level-start"><span class="level-item">September 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/08/"><span class="level-start"><span class="level-item">August 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/07/"><span class="level-start"><span class="level-item">July 2015</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/06/"><span class="level-start"><span class="level-item">June 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/05/"><span class="level-start"><span class="level-item">May 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/04/"><span class="level-start"><span class="level-item">April 2015</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/03/"><span class="level-start"><span class="level-item">March 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/02/"><span class="level-start"><span class="level-item">February 2015</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/01/"><span class="level-start"><span class="level-item">January 2015</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/12/"><span class="level-start"><span class="level-item">December 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/11/"><span class="level-start"><span class="level-item">November 2014</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/10/"><span class="level-start"><span class="level-item">October 2014</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/09/"><span class="level-start"><span class="level-item">September 2014</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/08/"><span class="level-start"><span class="level-item">August 2014</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/07/"><span class="level-start"><span class="level-item">July 2014</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/06/"><span class="level-start"><span class="level-item">June 2014</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/05/"><span class="level-start"><span class="level-item">May 2014</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/04/"><span class="level-start"><span class="level-item">April 2014</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/03/"><span class="level-start"><span class="level-item">March 2014</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/02/"><span class="level-start"><span class="level-item">February 2014</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2014/01/"><span class="level-start"><span class="level-item">January 2014</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/12/"><span class="level-start"><span class="level-item">December 2013</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/11/"><span class="level-start"><span class="level-item">November 2013</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2013/10/"><span class="level-start"><span class="level-item">October 2013</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Flutter/"><span class="tag">Flutter</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ghost/"><span class="tag">Ghost</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/H5/"><span class="tag">H5</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HTTPS/"><span class="tag">HTTPS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JavaScript/"><span class="tag">JavaScript</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Mac/"><span class="tag">Mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/React-Native/"><span class="tag">React Native</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Sublime/"><span class="tag">Sublime</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jQuery/"><span class="tag">jQuery</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nodejs/"><span class="tag">nodejs</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/npm/"><span class="tag">npm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%88%AC%E8%99%AB/"><span class="tag">爬虫</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%B5%E8%A7%86%E5%89%A7/"><span class="tag">电视剧</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BE%8E%E9%A3%9F/"><span class="tag">美食</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E7%AC%94/"><span class="tag">随笔</span><span class="tag">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/facvion.png" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 Ludis</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="GitHub" href="https://github.com/flute"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>